// Anytype API Base URL
const API_BASE_URL = 'http://localhost:31009/v1';
const API_VERSION = '2025-11-08';

// constants
const DEFAULT_ACCENT_COLOR = '#ff3030ff';

// State
let state = {
    apiKey: null,
    challengeId: null,
    theme: null,
    language: null,
    accentColor: null,
    whatDoOnStart: null,
    LastUsedForm: null,
    zoom: null,
    height: null,
    width: null,
    collapseOnOpenForm: null,
    forms: []
};

let WasJustOpened = true;

let themeSelectChoices = null;
let languageSelectChoices = null;
let whatDoOnStartSelectChoices = null;
let spaceSelectChoices = null;
let typeSelectChoices = null;
let collectionSelectChoices = null;
let templateSelectChoices = null;

let selectedSpaceId = null;

let selectedType = null;

let propertiesListForSaving = [];

let propertiesListSpawned = [];

let SelectedSpaceName = null;
let AllSpaces = null;
let allObjects = [];
let allCollections = [];
let allTemplatesForObject = [];
let currentForm = null;

let CashedTypes = null;

let URLWasRejected = false;

let WasSubscribeToggleCollapsedButton = false;

let turndownService = undefined;

function GetPropertyIconSVG(property) {
    // text, url, multi_select, checkbox, select, collection, template, objects, email, phone, number, date - I added icons

    if (property == "text") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="-1 -3 16 16" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.73944 7.19718C7.77641 7.28345 7.81338 7.39437 7.81338 7.50528C7.81338 7.99824 7.40669 8.39261 6.91373 8.39261C6.53169 
                        8.39261 6.19894 8.14613 6.08803 7.80106L5.75528 6.83979L2.0581 6.83979L1.72535 7.80106C1.61444 8.14613 1.26937 8.39261 0.887324 8.39261C0.394366 
                        8.39261 0 7.99824 0 7.50528C0 7.39437 0.0246479 7.28345 0.0616197 7.19718L2.46479 0.985915C2.68662 0.40669 3.2412 0 3.90669 0C4.55986 0 5.12676 
                        0.40669 5.34859 0.985915L7.73944 7.19718ZM2.60035 5.32394L5.21303 5.32394L3.90669 1.60211L2.60035 5.32394ZM11.3996 2.20599C12.7553 2.20599 14 
                        2.74824 14 4.46127L14 7.57923C14 8.02289 13.6549 8.39261 13.2113 8.39261C12.8169 8.39261 12.4718 8.09683 12.4225 7.69014C12.0282 8.15845 11.3257 
                        8.45423 10.5493 8.45423C9.60035 8.45423 8.47887 7.81338 8.47887 6.48239C8.47887 5.08979 9.60035 4.58451 10.5493 4.58451C11.338 4.58451 12.0405 
                        4.83099 12.4349 5.31162L12.4349 4.48592C12.4349 3.88204 11.9173 3.48768 11.1285 3.48768C10.6602 3.48768 10.2412 3.61092 9.80986 3.88204C9.72359 
                        3.93134 9.61268 3.96831 9.50176 3.96831C9.18134 3.96831 8.91021 3.69718 8.91021 3.36444C8.91021 3.14261 9.03345 2.94542 9.19366 2.84683C9.87148 
                        2.40317 10.6232 2.20599 11.3996 2.20599ZM11.1778 7.39437C11.6831 7.39437 12.1761 7.22183 12.4349 6.87676L12.4349 6.13732C12.1761 5.79225 11.6831 
                        5.61972 11.1778 5.61972C10.5616 5.61972 10.0563 5.95247 10.0563 6.51937C10.0563 7.07394 10.5616 7.39437 11.1778 7.39437ZM0.65625 9.625L13.3438 
                        9.625C13.7062 9.625 14 9.91881 14 10.2812C14 10.6437 13.7062 10.9375 13.3438 10.9375L0.65625 10.9375C0.293813 10.9375 4.43857e-17 10.6437 0 
                        10.2812C-4.43857e-17 9.91881 0.293813 9.625 0.65625 9.625Z" 
                    />
                </svg>`
    }
    else if (property == "url" || property == "URL" || property == "Url") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 -2 14 14" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.73333 1.86667L7.46667 1.86667C8.49613 1.86667 9.33333 2.70387 9.33333 3.73333C9.33333 4.7628 8.49613 5.6 7.46667 5.6L6.53333 
                        5.6C6.01813 5.6 5.6 6.0186 5.6 6.53333C5.6 7.04807 6.01813 7.46667 6.53333 7.46667L7.46667 7.46667C9.5284 7.46667 11.2 5.79507 11.2 3.73333C11.2 
                        1.6716 9.5284 0 7.46667 0L3.73333 0C1.6716 0 0 1.6716 0 3.73333C0 5.124 0.762067 6.33453 1.88953 6.97713C1.87553 6.83107 1.86667 6.6836 1.86667 
                        6.53333C1.86667 5.92013 1.98753 5.33447 2.2036 4.7978C1.99267 4.4954 1.86667 4.12953 1.86667 3.73333C1.86667 2.70387 2.70387 1.86667 3.73333 
                        1.86667ZM12.1095 3.28907C12.1231 3.4356 12.1333 3.58307 12.1333 3.73333C12.1333 4.34607 12.0101 4.9294 11.7931 5.46513C12.0059 5.768 12.1333 
                        6.13573 12.1333 6.53333C12.1333 7.5628 11.2961 8.4 10.2667 8.4L6.53333 8.4C5.50387 8.4 4.66667 7.5628 4.66667 6.53333C4.66667 5.50387 5.50387
                        4.66667 6.53333 4.66667L7.46667 4.66667C7.98187 4.66667 8.4 4.24807 8.4 3.73333C8.4 3.2186 7.98187 2.8 7.46667 2.8L6.53333 2.8C4.4716 2.8 
                        2.8 4.4716 2.8 6.53333C2.8 8.59507 4.4716 10.2667 6.53333 10.2667L10.2667 10.2667C12.3284 10.2667 14 8.59507 14 6.53333C14 5.14267 13.2375 
                        3.93167 12.1095 3.28907Z" 
                    />
                </svg>`
    }
    else if (property == "checkbox") {
        return `<svg style="margin-bottom: 10px; height: 20px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                    <path d="M384,1.42108547e-14 L384,384 L1.42108547e-14,384 L1.42108547e-14,1.42108547e-14 L384,1.42108547e-14 Z M341.333333,42.6666667 
                        L42.6666667,42.6666667 L42.6666667,341.333333 L341.333333,341.333333 L341.333333,42.6666667 Z M282.008132,104.106667 L315.325201,130.760322 
                        L173.998374,296.75219 L82.6731733,217.292032 L109.326827,183.974955 L167.317333,236.793494 L282.008132,104.106667 Z" 
                    />
                </svg>`
    }
    else if (property == "select") {
        return `<svg style="margin-bottom: 10px; height: 20px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 -20 500 500" xmlns="http://www.w3.org/2000/svg">
                    <path d="M314.763,204.944c13.811,0,25.004-11.194,25.004-24.972c0-13.81-11.192-24.989-25.004-24.989 c-13.793,0-24.972,11.18-24.972,
                        24.989C289.791,193.749,300.97,204.944,314.763,204.944z"></path> <path d="M406.638,179.972c0-13.81-11.19-24.989-24.983-24.989c-13.814,0-25.011,
                        11.18-25.011,24.989 c0,13.777,11.196,24.972,25.011,24.972C395.447,204.944,406.638,193.749,406.638,179.972z"></path> 
                        <path d="M253.014,179.94c0-69.764-56.745-126.508-126.509-126.508C56.74,53.432,0,110.176,0,179.94 C0,249.7,56.74,306.461,126.505,
                        306.461C196.268,306.461,253.014,249.7,253.014,179.94z M126.505,273.381 c-51.509,0-93.423-41.916-93.423-93.441c0-51.512,41.914-93.43,
                        93.423-93.43c51.513,0,93.425,41.918,93.425,93.43 C219.93,231.465,178.018,273.381,126.505,273.381z"></path> 
                        <path d="M78.55,162.008c-9.889,0-17.913,8.045-17.913,17.932c0,9.885,8.024,17.911,17.913,17.911 c9.899,0,17.913-8.026,17.913-17.911C96.463,
                        170.053,88.449,162.008,78.55,162.008z"></path> <path d="M126.505,162.008c-9.883,0-17.911,8.045-17.911,17.932c0,9.885,8.028,17.911,17.911,
                        17.911 c9.903,0,17.913-8.026,17.913-17.911C144.418,170.053,136.408,162.008,126.505,162.008z"></path> 
                        <path d="M174.45,162.008c-9.903,0-17.913,8.045-17.913,17.932c0,9.885,8.01,17.911,17.913,17.911 c9.897,0,17.911-8.026,17.911-17.911C192.361,170.053,
                        184.348,162.008,174.45,162.008z"></path> <path d="M487.628,376.807l-74.965-58.166c43.501-30.818,72.04-81.426,72.04-138.669c0-93.704-76.236-169.939-169.94-169.939 
                        c-41.948,0-80.325,15.359-110,40.639c9.758,5.927,18.833,12.857,26.978,20.753c23.066-17.688,51.783-28.315,83.022-28.315 c75.462,0,136.86,61.399,136.86,136.863c0,
                        49.75-26.782,93.265-66.596,117.216l-72.155-55.984c-3.312-2.552-7.733-3.1-11.562-1.437 c-3.831,1.665-6.428,5.298-6.802,9.451l-5.752,
                        64.996c-21.126-4.134-40.555-13.085-57.035-25.73 c-8.156,7.896-17.234,14.812-26.989,20.738c22.711,19.353,50.509,32.823,81.1,38.122l-10.805,122.258 c-0.402,
                        4.586,1.984,8.965,6.074,11.114c4.068,2.131,9.031,1.613,12.582-1.326L376.064,411l106.054-13.859 c4.573-0.598,8.318-3.891,9.529-8.335C492.859,384.365,
                        491.276,379.634,487.628,376.807z">
                    </path>
                </svg>`
    }
    else if (property == "collection" || property == "collections") {
        return `<svg style="margin-bottom: 10px; height: 20px; width: 16px; fill: var(--section-title-color)"
                    viewBox="800 -2300 1550 1550" xmlns="http://www.w3.org/2000/svg">
                        <g transform="scale(0.300000,-0.300000)"
                        stroke="none">
                        <path d="M4945 7780 c-35 -5 -37 -7 -15 -12 16 -3 13 -4 -10 -3 -42 4 -152
                        -24 -144 -36 3 -5 -2 -6 -10 -3 -17 7 -118 -35 -111 -46 3 -4 -2 -11 -11 -14
                        -9 -3 -12 -2 -9 5 4 5 -185 -86 -418 -203 -234 -117 -423 -216 -420 -222 3 -5
                        1 -6 -5 -2 -14 9 -642 -305 -635 -318 3 -5 1 -6 -5 -2 -6 4 -70 -23 -141 -59
                        -142 -72 -188 -113 -235 -208 -19 -37 -25 -61 -21 -91 4 -32 3 -35 -4 -16 -6
                        18 -8 5 -9 -50 0 -111 27 -186 90 -255 47 -51 74 -68 281 -171 126 -64 236
                        -113 244 -110 8 3 11 1 8 -4 -8 -13 81 -53 97 -44 6 4 8 3 5 -3 -8 -13 140
                        -86 155 -77 6 4 8 3 5 -2 -8 -14 620 -326 642 -319 9 3 26 -2 37 -11 18 -15
                        18 -15 -3 -5 -12 6 -25 11 -30 10 -4 0 48 -29 117 -64 78 -40 133 -62 145 -59
                        14 4 16 2 7 -4 -17 -11 30 -34 55 -26 13 4 14 3 5 -3 -16 -12 118 -71 244
                        -109 106 -31 323 -44 440 -25 100 15 206 49 198 63 -5 7 -2 8 5 4 16 -10 73
                        13 64 27 -4 6 -1 7 7 2 14 -8 252 104 245 115 -2 4 6 6 18 6 12 -1 21 4 20 11
                        -2 8 4 10 14 6 11 -4 14 -3 9 5 -5 8 -1 10 10 5 13 -5 15 -3 9 7 -5 8 -4 11 3
                        7 15 -10 43 3 35 16 -4 6 -1 7 7 2 18 -11 214 86 197 98 -8 6 -6 7 6 3 20 -6
                        789 373 781 386 -3 4 3 5 12 1 13 -5 15 -3 9 7 -5 8 -4 11 3 6 14 -9 65 12 57
                        24 -4 6 1 7 11 3 13 -5 15 -3 9 7 -5 8 -4 11 3 6 13 -8 63 14 56 25 -3 5 3 6
                        12 2 13 -5 15 -3 9 7 -5 9 -4 11 4 6 16 -10 123 42 115 56 -4 7 -2 8 4 4 24
                        -15 202 96 202 126 0 5 -6 6 -12 2 -9 -5 -9 -2 1 9 15 19 26 23 15 5 -4 -7 -3
                        -8 5 -4 13 9 36 50 45 86 6 20 5 22 -4 10 -10 -13 -11 -12 -6 3 3 10 6 28 7
                        40 1 20 2 20 9 -3 5 -16 7 2 5 50 -2 57 -1 65 5 35 6 -31 7 -25 4 26 -4 73
                        -20 130 -36 126 -6 -1 -13 4 -16 12 -3 9 0 11 8 6 7 -4 5 5 -5 24 -42 83 -63
                        95 -980 554 -543 272 -891 441 -910 441 -17 1 -29 6 -28 13 3 16 -93 51 -201
                        74 -90 18 -293 23 -381 9z m78 -7 c-7 -2 -21 -2 -30 0 -10 3 -4 5 12 5 17 0
                        24 -2 18 -5z m215 0 c-10 -2 -28 -2 -40 0 -13 2 -5 4 17 4 22 1 32 -1 23 -4z
                        m65 -10 c-7 -2 -21 -2 -30 0 -10 3 -4 5 12 5 17 0 24 -2 18 -5z m54 -9 c-3 -3
                        -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z m40 -10 c-3 -3 -12 -4 -19 -1
                        -8 3 -5 6 6 6 11 1 17 -2 13 -5z m103 -34 c8 -5 11 -10 5 -10 -5 0 -17 5 -25
                        10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m-780 -10 c-8 -5 -19 -10 -25 -10 -5
                        0 -3 5 5 10 8 5 20 10 25 10 6 0 3 -5 -5 -10z m996 -98 c-5 -4 -126 56 -126
                        63 0 3 29 -10 65 -27 35 -18 63 -34 61 -36z m-1141 28 c-3 -5 -12 -10 -18 -10
                        -7 0 -6 4 3 10 19 12 23 12 15 0z m1321 -118 c-5 -4 -146 66 -146 73 0 3 34
                        -12 75 -32 41 -20 73 -39 71 -41z m-1501 28 c-3 -5 -12 -10 -18 -10 -7 0 -6 4
                        3 10 19 12 23 12 15 0z m1555 -50 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5
                        -10 10 -5 10 6 0 17 -5 25 -10z m-1670 -5 c0 -6 -56 -35 -67 -35 -4 1 8 9 27
                        20 39 22 40 22 40 15z m1756 -43 c-5 -4 -66 26 -66 33 0 3 16 -3 35 -12 19 -9
                        33 -18 31 -21z m160 -80 c-5 -4 -126 56 -126 63 0 3 29 -10 65 -27 35 -18 63
                        -34 61 -36z m59 -30 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z
                        m-2320 -22 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m2424
                        -26 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m-2513 -19
                        c-11 -8 -25 -15 -30 -15 -6 1 0 7 14 15 32 19 40 18 16 0z m2593 -21 c14 -12
                        -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m-2684 -24 c-3 -5 -12
                        -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m2740 -8 c-3 -3 -11 0 -18 7 -9
                        10 -8 11 6 5 10 -3 15 -9 12 -12z m-2829 -37 c-11 -8 -25 -15 -30 -15 -6 1 0
                        7 14 15 32 19 40 18 16 0z m2950 -23 c-5 -4 -66 26 -66 33 0 3 16 -3 35 -12
                        19 -9 33 -18 31 -21z m-2996 3 c0 -6 -56 -35 -67 -35 -4 1 8 9 27 20 39 22 40
                        22 40 15z m3059 -31 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29
                        -15z m97 -52 c-5 -4 -66 26 -66 33 0 3 16 -3 35 -12 19 -9 33 -18 31 -21z
                        m-3341 -12 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m3404
                        -16 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m-3484 -24
                        c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m3560 -18 c-3 -3
                        -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m-3620 -12 c-3 -5 -12 -10
                        -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m3704 -26 c14 -12 -19 -1 -35 12
                        -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m-3744 6 c-3 -5 -12 -10 -18 -10 -7 0
                        -6 4 3 10 19 12 23 12 15 0z m-60 -30 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10
                        19 12 23 12 15 0z m3860 -8 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9
                        12 -12z m104 -48 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29
                        -15z m-4064 6 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m4235
                        -95 c0 -3 -31 11 -70 30 -38 19 -70 38 -70 40 0 3 32 -11 70 -30 39 -19 70
                        -38 70 -40z m-4361 32 c-16 -12 -79 -45 -79 -42 0 7 63 45 74 45 5 0 7 -1 5
                        -3z m4461 -124 c0 -8 -9 0 -50 45 l-45 47 48 -45 c26 -24 47 -45 47 -47z
                        m-4560 64 c0 -2 -10 -12 -22 -23 l-23 -19 19 23 c18 21 26 27 26 19z m-77
                        -112 c-9 -19 -18 -33 -21 -31 -4 5 26 66 33 66 3 0 -3 -16 -12 -35z m4684 -87
                        c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m-4720 -140 c-3 -7 -5
                        -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m4694 -105 c-12 -20 -14 -14 -5 12
                        4 9 9 14 11 11 3 -2 0 -13 -6 -23z m-4647 -19 c3 -8 2 -12 -4 -9 -6 3 -10 10
                        -10 16 0 14 7 11 14 -7z m67 -81 c13 -16 12 -17 -3 -4 -17 13 -22 21 -14 21 2
                        0 10 -8 17 -17z m4514 7 c-3 -5 -11 -10 -16 -10 -6 0 -7 5 -4 10 3 6 11 10 16
                        10 6 0 7 -4 4 -10z m-4461 -49 c-2 -3 -12 3 -22 13 -16 17 -16 18 5 5 12 -7
                        20 -15 17 -18z m4406 14 c0 -2 -10 -9 -22 -15 -22 -11 -22 -10 -4 4 21 17 26
                        19 26 11z m-4310 -55 c19 -11 31 -19 25 -19 -5 0 -26 8 -45 19 -19 11 -30 19
                        -25 19 6 0 26 -8 45 -19z m89 -46 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14
                        -6 27 -13 29 -15z m91 -44 c30 -16 51 -29 45 -29 -5 0 -35 13 -65 29 -30 16
                        -50 29 -45 29 6 0 35 -13 65 -29z m225 -110 c3 -6 -1 -7 -9 -4 -18 7 -21 14
                        -7 14 6 0 13 -4 16 -10z m100 -50 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0
                        13 -4 16 -10z m3215 6 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z
                        m-60 -31 c-14 -8 -29 -14 -35 -14 -5 0 1 6 15 14 14 8 30 14 35 14 6 0 -1 -6
                        -15 -14z m-3090 -5 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6
                        0 17 -5 25 -10z m3029 -24 c-10 -9 -69 -36 -69 -32 0 7 52 35 64 36 5 0 7 -2
                        5 -4z m-2909 -36 c30 -16 51 -29 45 -29 -5 0 -35 13 -65 29 -30 16 -50 29 -45
                        29 6 0 35 -13 65 -29z m2809 -14 c-2 -2 -15 -9 -29 -15 -24 -11 -24 -11 -6 3
                        16 13 49 24 35 12z m-2699 -41 c17 -9 30 -18 30 -21 0 -4 -59 23 -69 32 -10 9
                        13 3 39 -11z m2620 0 c-14 -8 -29 -14 -35 -14 -5 0 1 6 15 14 14 8 30 14 35
                        14 6 0 -1 -6 -15 -14z m-50 -20 c0 -2 -18 -14 -40 -25 -22 -11 -40 -18 -40
                        -15 0 2 17 13 38 24 42 23 42 23 42 16z m-2480 -25 c8 -5 11 -10 5 -10 -5 0
                        -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m60 -30 c8 -5 11 -10 5 -10
                        -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m2330 6 c0 -2 -7 -7
                        -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-70 -31 c0 -2 -10 -9 -22 -15
                        -22 -11 -22 -10 -4 4 21 17 26 19 26 11z m-2035 -93 c-3 -3 -11 0 -18 7 -9 10
                        -8 11 6 5 10 -3 15 -9 12 -12z m200 -92 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14
                        6 0 13 -4 16 -10z m71 -36 c18 -14 18 -14 -6 -3 -31 14 -36 19 -24 19 6 0 19
                        -7 30 -16z m1324 2 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z
                        m-60 -30 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-1085 -56
                        c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z m970 0 c-3 -5 -12
                        -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-148 -66 c-3 -3 -12 -4 -19 -1
                        -8 3 -5 6 6 6 11 1 17 -2 13 -5z m-600 -20 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6
                        6 11 1 17 -2 13 -5z m86 -21 c-7 -2 -19 -2 -25 0 -7 3 -2 5 12 5 14 0 19 -2
                        13 -5z m360 0 c-7 -2 -19 -2 -25 0 -7 3 -2 5 12 5 14 0 19 -2 13 -5z m-75 -10
                        c-10 -2 -28 -2 -40 0 -13 2 -5 4 17 4 22 1 32 -1 23 -4z"/>
                        <path d="M3015 5674 c-108 -55 -195 -115 -195 -135 0 -6 6 -7 13 -3 6 4 3 -2
                        -7 -14 -23 -26 -34 -30 -15 -4 13 15 12 16 -2 4 -35 -27 -62 -113 -65 -207 -3
                        -65 -1 -83 6 -65 8 20 9 16 5 -18 -4 -28 -2 -41 5 -37 5 3 7 0 4 -9 -7 -18 27
                        -85 67 -131 30 -34 58 -49 43 -22 -4 7 -3 9 2 4 5 -5 9 -14 9 -19 0 -6 6 -13
                        14 -16 9 -3 11 0 6 8 -5 9 -4 11 4 6 6 -4 9 -12 6 -17 -5 -7 294 -159 312
                        -159 2 0 1 5 -3 12 -4 7 -3 8 5 4 6 -4 9 -11 7 -15 -8 -12 170 -95 184 -86 9
                        6 11 4 5 -5 -6 -10 -4 -12 9 -7 10 4 15 3 11 -3 -8 -12 73 -53 91 -46 10 4 12
                        2 8 -6 -5 -8 -2 -9 9 -5 10 4 16 2 14 -6 -1 -7 8 -12 20 -11 12 0 21 -3 20 -7
                        -3 -12 283 -150 296 -142 5 3 7 2 4 -4 -8 -13 387 -208 403 -198 9 6 11 4 5
                        -5 -6 -10 -4 -12 9 -7 9 4 15 3 12 -1 -7 -11 163 -94 176 -86 6 4 8 3 5 -3 -8
                        -13 41 -36 55 -27 7 5 8 2 3 -6 -6 -10 -4 -12 9 -7 9 4 15 3 12 -2 -8 -12 154
                        -85 260 -117 82 -25 103 -28 264 -28 155 -1 185 2 257 23 46 13 80 27 77 32
                        -3 5 2 6 10 3 20 -8 277 116 269 129 -4 6 -1 7 7 2 7 -4 16 -2 21 6 4 8 14 14
                        21 15 34 3 39 5 32 16 -5 7 -3 8 6 3 16 -10 311 135 303 148 -3 6 -1 7 5 3 13
                        -8 123 44 116 56 -3 4 3 5 12 1 13 -5 15 -3 9 7 -5 8 -4 11 3 7 15 -10 43 3
                        35 16 -3 5 -1 7 5 3 13 -8 103 34 96 46 -3 4 3 5 12 1 13 -5 15 -3 9 7 -5 8
                        -4 11 3 7 15 -10 43 3 35 16 -3 5 -1 7 5 3 14 -9 83 25 75 37 -4 6 -1 7 7 2
                        18 -11 214 86 197 98 -8 6 -6 7 6 3 22 -7 601 280 592 294 -3 5 4 15 15 23 12
                        8 32 30 46 48 13 18 24 28 24 22 0 -6 -18 -29 -40 -52 -22 -22 -36 -41 -32
                        -41 12 0 55 48 85 95 31 47 57 141 57 203 0 51 -20 138 -29 124 -3 -6 -14 8
                        -23 31 -13 32 -14 37 -3 23 8 -11 15 -24 15 -30 0 -5 3 -7 6 -3 10 10 -57 108
                        -69 100 -5 -3 -7 -1 -3 5 10 16 -47 55 -174 117 -73 35 -122 54 -133 49 -9 -3
                        -14 -11 -10 -17 4 -6 1 -7 -6 -2 -17 10 -363 -154 -354 -168 3 -6 1 -7 -5 -3
                        -13 8 -123 -44 -116 -56 3 -4 -1 -5 -9 -3 -17 7 -69 -19 -59 -30 4 -5 2 -5 -5
                        -1 -15 8 -264 -115 -256 -128 3 -5 1 -6 -5 -2 -13 7 -203 -84 -196 -95 2 -4
                        -5 -5 -16 -2 -13 3 -22 -1 -26 -11 -4 -9 -16 -21 -28 -27 -20 -10 -20 -10 -2
                        5 11 9 17 16 13 16 -18 0 -315 -155 -311 -162 3 -4 -1 -5 -9 -2 -8 3 -56 -16
                        -107 -41 -52 -25 -118 -53 -147 -62 -28 -9 -49 -21 -46 -26 3 -6 1 -7 -5 -3
                        -6 3 -30 3 -54 0 -30 -5 -37 -9 -24 -14 10 -3 -73 -6 -185 -6 -111 0 -197 2
                        -189 4 7 3 -20 13 -61 24 -40 10 -80 16 -89 13 -8 -3 -11 -3 -7 1 10 10 -133
                        76 -151 69 -7 -2 -10 -1 -7 5 7 11 -84 52 -98 43 -6 -4 -7 -1 -2 7 6 10 4 12
                        -9 7 -9 -4 -15 -3 -12 1 8 13 -589 306 -604 297 -8 -5 -11 -4 -7 2 7 12 -60
                        46 -74 37 -5 -3 -8 0 -7 8 2 8 -6 13 -19 12 -12 0 -19 4 -16 9 4 6 -1 8 -11 4
                        -9 -4 -15 -3 -12 2 6 8 -555 287 -596 295 -15 4 -60 -13 -133 -50z m96 26
                        c-24 -11 -46 -20 -50 -20 -12 1 64 39 79 39 8 0 -5 -8 -29 -19z m4049 -5 c14
                        -8 21 -14 15 -14 -5 0 -21 6 -35 14 -14 8 -20 14 -15 14 6 0 21 -6 35 -14z
                        m-3945 -13 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m-165 -7
                        c0 -3 -33 -21 -72 -41 -40 -20 -84 -46 -98 -58 l-25 -21 20 24 c11 13 54 40
                        95 62 84 42 80 41 80 34z m225 -23 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3
                        15 -9 12 -12z m3955 8 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5
                        10 6 0 17 -5 25 -10z m-3915 -28 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15
                        -9 12 -12z m4050 -53 c19 -23 19 -22 -11 1 -17 14 -40 31 -50 38 -11 7 -7 6
                        11 -2 17 -8 39 -24 50 -37z m-3984 23 c-7 -2 -18 1 -23 6 -8 8 -4 9 13 5 13
                        -4 18 -8 10 -11z m3509 14 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14
                        25 6z m-3455 -36 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z
                        m3375 -4 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-40 -20 c0
                        -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-3225 -34 c-3 -3 -11 0
                        -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m3876 1 c13 -16 12 -17 -3 -4 -10
                        7 -18 15 -18 17 0 8 8 3 21 -13z m-3791 -38 c14 -8 21 -14 15 -14 -5 0 -21 6
                        -35 14 -14 8 -20 14 -15 14 6 0 21 -6 35 -14z m-844 -32 c-8 -15 -15 -25 -16
                        -21 0 12 23 58 27 54 3 -2 -2 -17 -11 -33z m919 -11 c-3 -3 -11 0 -18 7 -9 10
                        -8 11 6 5 10 -3 15 -9 12 -12z m3772 -54 c-3 -8 -6 -5 -6 6 -1 11 2 17 5 13 3
                        -3 4 -12 1 -19z m-1072 -8 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12
                        15 0z m-3648 -22 c-3 -8 -6 -5 -6 6 -1 11 2 17 5 13 3 -3 4 -12 1 -19z m1108
                        4 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m3622 -84 c-2 -18
                        -4 -4 -4 32 0 36 2 50 4 33 2 -18 2 -48 0 -65z m-1137 77 c0 -2 -10 -9 -22
                        -15 -22 -11 -22 -10 -4 4 21 17 26 19 26 11z m-2380 -35 c8 -5 11 -10 5 -10
                        -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m66 -36 c18 -14 18
                        -14 -6 -3 -31 14 -36 19 -24 19 6 0 19 -7 30 -16z m104 -49 c36 -19 61 -34 55
                        -34 -5 0 -39 15 -75 34 -36 19 -60 34 -55 34 6 0 39 -15 75 -34z m3337 -17
                        c-3 -8 -6 -5 -6 6 -1 11 2 17 5 13 3 -3 4 -12 1 -19z m-3181 -66 c-5 -4 -86
                        36 -86 43 0 3 20 -5 45 -17 24 -12 43 -23 41 -26z m3171 26 c-3 -8 -6 -5 -6 6
                        -1 11 2 17 5 13 3 -3 4 -12 1 -19z m-1547 -38 c-19 -11 -39 -19 -45 -19 -5 0
                        6 8 25 19 19 11 40 19 45 19 6 0 -6 -8 -25 -19z m-1561 -16 c14 -12 -19 -1
                        -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m-1509 -73 c0 -10 -49 53 -50
                        63 0 6 11 -5 25 -24 14 -19 25 -36 25 -39z m1589 33 c14 -12 -19 -1 -35 12
                        -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m1401 16 c-8 -5 -19 -10 -25 -10 -5 0
                        -3 5 5 10 8 5 20 10 25 10 6 0 3 -5 -5 -10z m-40 -15 c0 -6 -56 -35 -67 -35
                        -4 1 8 9 27 20 39 22 40 22 40 15z m-1225 -73 c-3 -3 -11 0 -18 7 -9 10 -8 11
                        6 5 10 -3 15 -9 12 -12z m1055 -12 c-8 -5 -19 -10 -25 -10 -5 0 -3 5 5 10 8 5
                        20 10 25 10 6 0 3 -5 -5 -10z m1700 5 c0 -2 -10 -9 -22 -15 -22 -11 -22 -10
                        -4 4 21 17 26 19 26 11z m-4375 -23 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3
                        15 -9 12 -12z m2621 -7 c-11 -8 -25 -15 -30 -15 -6 1 0 7 14 15 32 19 40 18
                        16 0z m-881 -15 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z
                        m-1661 -9 c4 -5 -3 -7 -14 -4 -23 6 -26 13 -6 13 8 0 17 -4 20 -9z m4186 -5
                        c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-4105 -36 c3 -6 -1
                        -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z m1732 -6 c-3 -3 -12 -4 -19 -1
                        -8 3 -5 6 6 6 11 1 17 -2 13 -5z m2293 2 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9
                        4 6 10 25 14 25 6z m-2253 -12 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2
                        13 -5z m-1687 -24 c0 -5 -7 -7 -15 -4 -8 4 -15 8 -15 10 0 2 7 4 15 4 8 0 15
                        -4 15 -10z m3859 -4 c-10 -9 -109 -56 -109 -51 0 6 91 54 104 55 5 0 7 -2 5
                        -4z m-3750 -52 c14 -12 -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z
                        m3607 -19 c-11 -8 -25 -15 -30 -15 -6 1 0 7 14 15 32 19 40 18 16 0z m-3552
                        -4 c4 -5 -3 -7 -14 -4 -23 6 -26 13 -6 13 8 0 17 -4 20 -9z m3501 -21 c-3 -5
                        -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-40 -20 c-3 -5 -12 -10
                        -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-3300 -40 c3 -5 -4 -6 -15 -3 -11
                        3 -22 9 -25 13 -3 5 4 6 15 3 11 -3 22 -9 25 -13z m3180 -20 c-3 -5 -12 -10
                        -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-3060 -40 c3 -6 -1 -7 -9 -4 -18 7
                        -21 14 -7 14 6 0 13 -4 16 -10z m95 -45 c39 -19 70 -38 70 -40 0 -5 -139 62
                        -149 71 -13 12 18 0 79 -31z m216 -111 c18 -14 18 -14 -6 -3 -31 14 -36 19
                        -24 19 6 0 19 -7 30 -16z m49 -24 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0
                        13 -4 16 -10z m2204 -24 c-2 -2 -15 -9 -29 -15 -24 -11 -24 -11 -6 3 16 13 49
                        24 35 12z m-2039 -56 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10
                        6 0 17 -5 25 -10z m1940 6 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14
                        25 6z m-61 -30 c-10 -9 -89 -46 -89 -41 0 6 72 44 84 45 5 0 7 -2 5 -4z m-99
                        -50 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-251 -120 c-2
                        -2 -15 -9 -29 -15 -24 -11 -24 -11 -6 3 16 13 49 24 35 12z m-1044 -46 c3 -6
                        -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z m45 -20 c8 -5 11 -10 5 -10
                        -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m165 -60 c13 -5 14 -9
                        5 -9 -8 0 -24 4 -35 9 -13 5 -14 9 -5 9 8 0 24 -4 35 -9z m532 -6 c-3 -3 -12
                        -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z m-480 -10 c-3 -3 -12 -4 -19 -1 -8
                        3 -5 6 6 6 11 1 17 -2 13 -5z m56 -11 c-7 -2 -19 -2 -25 0 -7 3 -2 5 12 5 14
                        0 19 -2 13 -5z m334 1 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z
                        m-234 -11 c-13 -2 -35 -2 -50 0 -16 2 -5 4 22 4 28 0 40 -2 28 -4z m164 1 c-3
                        -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z"/>
                        <path d="M7072 4536 c-13 -7 -20 -15 -17 -18 3 -3 -1 -8 -10 -12 -9 -3 -13 -2
                        -10 4 10 16 0 12 -109 -42 -58 -29 -102 -56 -99 -62 3 -5 1 -6 -5 -3 -14 9
                        -43 -3 -36 -14 3 -5 -1 -6 -8 -4 -19 7 -661 -309 -651 -320 4 -4 3 -5 -4 -1
                        -15 8 -124 -45 -116 -57 3 -6 1 -7 -5 -4 -15 10 -43 -3 -35 -16 3 -5 1 -7 -5
                        -3 -14 9 -63 -14 -55 -27 4 -6 1 -7 -7 -2 -15 9 -252 -104 -244 -117 3 -4 -1
                        -5 -8 -3 -8 3 -52 -12 -99 -34 -46 -22 -125 -52 -174 -67 -84 -26 -103 -28
                        -285 -30 -107 -1 -187 2 -176 5 13 5 2 11 -40 20 -90 20 -180 59 -500 216
                        -174 85 -302 142 -312 139 -12 -4 -13 -3 -5 3 17 12 -119 79 -137 68 -8 -5
                        -11 -4 -7 1 8 14 -527 279 -543 269 -8 -5 -11 -4 -7 2 6 10 -197 113 -221 113
                        -28 0 -260 -124 -294 -157 -36 -35 -51 -62 -26 -47 7 4 8 3 4 -5 -4 -6 -12 -9
                        -17 -5 -5 3 -20 -18 -33 -47 -19 -40 -24 -64 -21 -103 4 -46 3 -47 -5 -16 -7
                        26 -8 12 -6 -55 4 -108 33 -182 93 -242 45 -45 257 -158 279 -149 8 3 13 2 10
                        -3 -7 -11 22 -23 36 -14 7 3 8 1 4 -5 -4 -7 -4 -12 1 -13 4 0 20 -2 35 -3 15
                        -1 33 -8 40 -15 11 -11 9 -11 -10 -1 -13 6 -25 10 -27 8 -2 -2 306 -158 684
                        -347 443 -222 693 -341 701 -336 9 6 11 4 5 -5 -6 -10 -4 -12 9 -7 9 4 15 3
                        12 -1 -7 -12 109 -66 123 -58 6 4 19 2 28 -4 15 -9 14 -10 -7 -5 -60 14 12
                        -16 95 -40 68 -19 104 -24 150 -21 45 4 51 3 25 -3 -25 -6 2 -9 90 -9 72 -1
                        150 5 185 12 33 8 51 15 40 16 l-20 1 20 9 c11 5 29 9 40 9 l20 0 -20 -9 c-46
                        -20 9 -8 76 16 95 34 375 173 372 185 -2 4 5 5 14 2 11 -4 14 -3 9 5 -4 7 -2
                        10 7 7 17 -7 69 19 59 30 -4 5 -2 5 5 1 13 -7 604 284 598 294 -2 4 6 6 18 6
                        13 -1 21 4 19 12 -1 8 2 11 7 8 13 -9 83 23 76 34 -4 6 1 7 11 3 13 -5 15 -3
                        9 7 -5 8 -4 11 3 6 13 -8 63 14 56 25 -3 5 1 6 9 3 16 -6 532 249 615 304 185
                        122 202 422 33 575 -48 44 -157 101 -178 93 -8 -3 -12 -2 -9 2 3 5 -19 20 -48
                        34 -44 22 -56 24 -74 14z m104 -44 c-5 -4 -86 36 -86 43 0 3 20 -5 45 -17 24
                        -12 43 -23 41 -26z m-4023 31 c-7 -2 -19 -2 -25 0 -7 3 -2 5 12 5 14 0 19 -2
                        13 -5z m-48 -13 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z
                        m115 -10 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5
                        25 -10z m-155 -10 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z
                        m3945 0 c-8 -5 -19 -10 -25 -10 -5 0 -3 5 5 10 8 5 20 10 25 10 6 0 3 -5 -5
                        -10z m-3705 -38 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z
                        m3640 8 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-3975 -14
                        c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m4346 -17 c19 -11 34
                        -23 34 -26 0 -4 -62 30 -79 44 -16 12 18 -1 45 -18z m-440 -4 c-11 -8 -25 -15
                        -30 -15 -6 1 0 7 14 15 32 19 40 18 16 0z m-3946 0 c0 -2 -10 -9 -22 -15 -22
                        -11 -22 -10 -4 4 21 17 26 19 26 11z m-60 -38 c0 -2 -10 -12 -22 -23 l-23 -19
                        19 23 c18 21 26 27 26 19z m626 -23 c18 -14 18 -14 -6 -3 -31 14 -36 19 -24
                        19 6 0 19 -7 30 -16z m3925 -26 c15 -28 5 -21 -21 15 -15 20 -17 27 -6 18 9
                        -8 22 -23 27 -33z m-721 2 c-19 -11 -39 -19 -45 -19 -5 0 6 8 25 19 19 11 40
                        19 45 19 6 0 -6 -8 -25 -19z m-3140 -5 c14 -8 21 -14 15 -14 -5 0 -21 6 -35
                        14 -14 8 -20 14 -15 14 6 0 21 -6 35 -14z m-774 -72 c-8 -15 -15 -25 -16 -21
                        0 12 23 58 27 54 3 -2 -2 -17 -11 -33z m904 7 c30 -16 51 -29 45 -29 -5 0 -35
                        13 -65 29 -30 16 -50 29 -45 29 6 0 35 -13 65 -29z m3779 -30 c0 -8 -6 0 -14
                        19 -8 18 -15 36 -15 40 1 13 29 -45 29 -59z m-919 25 c-25 -13 -49 -24 -55
                        -24 -5 0 10 11 35 24 25 13 50 24 55 24 6 0 -10 -11 -35 -24z m927 -67 c-3 -8
                        -6 -5 -6 6 -1 11 2 17 5 13 3 -3 4 -12 1 -19z m-3647 2 c8 -5 11 -10 5 -10 -5
                        0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m2585 0 c-3 -5 -12 -10
                        -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-60 -30 c-3 -5 -12 -10 -18 -10 -7
                        0 -6 4 3 10 19 12 23 12 15 0z m1132 -22 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2
                        -7 2 -19 0 -25z m0 -70 c-2 -13 -4 -5 -4 17 -1 22 1 32 4 23 2 -10 2 -28 0
                        -40z m-3472 32 c3 -6 -1 -7 -9 -4 -18 7 -21 14 -7 14 6 0 13 -4 16 -10z m2185
                        -15 c-14 -8 -29 -14 -35 -14 -5 0 1 6 15 14 14 8 30 14 35 14 6 0 -1 -6 -15
                        -14z m-3443 -37 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m1383
                        -14 c0 -2 -9 0 -20 6 -11 6 -20 13 -20 16 0 2 9 0 20 -6 11 -6 20 -13 20 -16z
                        m3337 -26 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m-3277 2 c19
                        -11 31 -19 25 -19 -5 0 -26 8 -45 19 -19 11 -30 19 -25 19 6 0 26 -8 45 -19z
                        m1845 0 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-1719 -68
                        c-5 -4 -86 36 -86 43 0 3 20 -5 45 -17 24 -12 43 -23 41 -26z m-1526 -17 c0
                        -5 -5 -3 -10 5 -5 8 -10 20 -10 25 0 6 5 3 10 -5 5 -8 10 -19 10 -25z m4651
                        12 c-10 -9 -11 -8 -5 6 3 10 9 15 12 12 3 -3 0 -11 -7 -18z m-3086 -15 c-3 -3
                        -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m-1520 -51 c20 -22 64 -54
                        100 -72 35 -19 62 -35 60 -37 -9 -10 -127 64 -166 104 -24 24 -40 44 -36 44 4
                        0 23 -18 42 -39z m1641 -9 c-5 -4 -66 26 -66 33 0 3 16 -3 35 -12 19 -9 33
                        -18 31 -21z m1324 34 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z
                        m1594 -27 c-31 -33 -107 -89 -121 -89 -4 0 15 15 42 34 28 18 61 45 74 60 14
                        14 27 26 30 26 2 0 -8 -14 -25 -31z m-1664 -9 c-19 -11 -39 -19 -45 -19 -5 0
                        6 8 25 19 19 11 40 19 45 19 6 0 -6 -8 -25 -19z m-1140 -45 c47 -24 81 -44 75
                        -44 -5 0 -48 20 -95 44 -47 24 -80 44 -75 44 6 0 48 -20 95 -44z m940 -50
                        c-14 -8 -32 -14 -40 -14 -8 0 -1 6 15 14 40 18 57 18 25 0z m1725 5 c-3 -5
                        -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-2545 -10 c8 -5 11 -10 5
                        -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m-1675 -18 c-3 -3
                        -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m4185 13 c0 -6 -97 -55 -107
                        -55 -4 1 17 14 47 30 61 32 60 32 60 25z m-2460 -15 c8 -5 11 -10 5 -10 -5 0
                        -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m100 -32 c18 -5 13 -6 -15
                        -2 -22 3 -47 10 -55 15 -16 10 24 3 70 -13z m497 -4 c-3 -3 -12 -4 -19 -1 -8
                        3 -5 6 6 6 11 1 17 -2 13 -5z m-374 -21 c-7 -2 -19 -2 -25 0 -7 3 -2 5 12 5
                        14 0 19 -2 13 -5z m274 1 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13
                        -5z m-84 -11 c-29 -2 -77 -2 -105 0 -29 2 -6 3 52 3 58 0 81 -1 53 -3z m-1863
                        -58 c17 -9 30 -18 30 -21 0 -4 -59 23 -69 32 -10 9 13 3 39 -11z m3636 0 c-11
                        -8 -25 -15 -30 -15 -6 1 0 7 14 15 32 19 40 18 16 0z m-3546 -45 c19 -11 31
                        -19 25 -19 -5 0 -26 8 -45 19 -19 11 -30 19 -25 19 6 0 26 -8 45 -19z m3395
                        -30 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-3315 -10 c8
                        -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z m65
                        -38 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m84 -38 c14 -12
                        -19 -1 -35 12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m2971 -8 c0 -2 -7 -7
                        -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-2890 -31 c14 -8 21 -14 15 -14
                        -5 0 -21 6 -35 14 -14 8 -20 14 -15 14 6 0 21 -6 35 -14z m2730 -49 c0 -2 -7
                        -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-2551 -42 c14 -12 -19 -1 -35
                        12 -18 14 -18 14 6 3 14 -6 27 -13 29 -15z m2511 22 c0 -2 -7 -7 -16 -10 -8
                        -3 -12 -2 -9 4 6 10 25 14 25 6z m-2451 -52 c14 -12 -19 -1 -35 12 -18 14 -18
                        14 6 3 14 -6 27 -13 29 -15z m2331 -8 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4
                        6 10 25 14 25 6z m-40 -20 c0 -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14
                        25 6z m-2155 -44 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z
                        m2000 -32 c-3 -5 -12 -10 -18 -10 -7 0 -6 4 3 10 19 12 23 12 15 0z m-1905
                        -10 c8 -5 11 -10 5 -10 -5 0 -17 5 -25 10 -8 5 -10 10 -5 10 6 0 17 -5 25 -10z
                        m65 -38 c-3 -3 -11 0 -18 7 -9 10 -8 11 6 5 10 -3 15 -9 12 -12z m1545 -96 c0
                        -2 -7 -7 -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-40 -20 c0 -2 -7 -7
                        -16 -10 -8 -3 -12 -2 -9 4 6 10 25 14 25 6z m-100 -50 c0 -2 -7 -7 -16 -10 -8
                        -3 -12 -2 -9 4 6 10 25 14 25 6z m-970 -41 c14 -8 21 -14 15 -14 -5 0 -21 6
                        -35 14 -14 8 -20 14 -15 14 6 0 21 -6 35 -14z m890 0 c-14 -8 -29 -14 -35 -14
                        -5 0 1 6 15 14 14 8 30 14 35 14 6 0 -1 -6 -15 -14z m-80 -35 c-8 -5 -19 -10
                        -25 -10 -5 0 -3 5 5 10 8 5 20 10 25 10 6 0 3 -5 -5 -10z m-623 -36 c-3 -3
                        -12 -4 -19 -1 -8 3 -5 6 6 6 11 1 17 -2 13 -5z m96 -21 c-7 -2 -21 -2 -30 0
                        -10 3 -4 5 12 5 17 0 24 -2 18 -5z m334 1 c-3 -3 -12 -4 -19 -1 -8 3 -5 6 6 6
                        11 1 17 -2 13 -5z m-74 -11 c-13 -2 -33 -2 -45 0 -13 2 -3 4 22 4 25 0 35 -2
                        23 -4z"/>
                    </g>
                </svg>`
    }
    else if (property == "select") {
        return `<svg style="margin-bottom: 10px; height: 20px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 -20 500 500" xmlns="http://www.w3.org/2000/svg">
                    <path d="M314.763,204.944c13.811,0,25.004-11.194,25.004-24.972c0-13.81-11.192-24.989-25.004-24.989 c-13.793,0-24.972,11.18-24.972,
                        24.989C289.791,193.749,300.97,204.944,314.763,204.944z"></path> <path d="M406.638,179.972c0-13.81-11.19-24.989-24.983-24.989c-13.814,0-25.011,
                        11.18-25.011,24.989 c0,13.777,11.196,24.972,25.011,24.972C395.447,204.944,406.638,193.749,406.638,179.972z"></path> 
                        <path d="M253.014,179.94c0-69.764-56.745-126.508-126.509-126.508C56.74,53.432,0,110.176,0,179.94 C0,249.7,56.74,306.461,126.505,
                        306.461C196.268,306.461,253.014,249.7,253.014,179.94z M126.505,273.381 c-51.509,0-93.423-41.916-93.423-93.441c0-51.512,41.914-93.43,
                        93.423-93.43c51.513,0,93.425,41.918,93.425,93.43 C219.93,231.465,178.018,273.381,126.505,273.381z"></path> 
                        <path d="M78.55,162.008c-9.889,0-17.913,8.045-17.913,17.932c0,9.885,8.024,17.911,17.913,17.911 c9.899,0,17.913-8.026,17.913-17.911C96.463,
                        170.053,88.449,162.008,78.55,162.008z"></path> <path d="M126.505,162.008c-9.883,0-17.911,8.045-17.911,17.932c0,9.885,8.028,17.911,17.911,
                        17.911 c9.903,0,17.913-8.026,17.913-17.911C144.418,170.053,136.408,162.008,126.505,162.008z"></path> 
                        <path d="M174.45,162.008c-9.903,0-17.913,8.045-17.913,17.932c0,9.885,8.01,17.911,17.913,17.911 c9.897,0,17.911-8.026,17.911-17.911C192.361,170.053,
                        184.348,162.008,174.45,162.008z"></path> <path d="M487.628,376.807l-74.965-58.166c43.501-30.818,72.04-81.426,72.04-138.669c0-93.704-76.236-169.939-169.94-169.939 
                        c-41.948,0-80.325,15.359-110,40.639c9.758,5.927,18.833,12.857,26.978,20.753c23.066-17.688,51.783-28.315,83.022-28.315 c75.462,0,136.86,61.399,136.86,136.863c0,
                        49.75-26.782,93.265-66.596,117.216l-72.155-55.984c-3.312-2.552-7.733-3.1-11.562-1.437 c-3.831,1.665-6.428,5.298-6.802,9.451l-5.752,
                        64.996c-21.126-4.134-40.555-13.085-57.035-25.73 c-8.156,7.896-17.234,14.812-26.989,20.738c22.711,19.353,50.509,32.823,81.1,38.122l-10.805,122.258 c-0.402,
                        4.586,1.984,8.965,6.074,11.114c4.068,2.131,9.031,1.613,12.582-1.326L376.064,411l106.054-13.859 c4.573-0.598,8.318-3.891,9.529-8.335C492.859,384.365,
                        491.276,379.634,487.628,376.807z">
                    </path>
                </svg>`
    }
    else if (property == "template" || property == "templates") {
        return `<svg style="margin-bottom: 10px; height: 20px; width: 16px; fill: var(--section-title-color)"
                    viewBox="800 -6500 5500 5500" xmlns="http://www.w3.org/2000/svg">
                        <g transform="scale(1.0,-1.0)"
                        stroke="none">
                        <path d="M2411 6144 c-118 -32 -237 -125 -293 -230 -49 -92 -58 -148 -58 -381
                        l0 -213 -208 0 c-227 0 -285 -9 -376 -58 -65 -35 -153 -123 -188 -188 -61
                        -114 -58 -19 -58 -1754 0 -1735 -3 -1640 58 -1754 35 -65 123 -153 188 -188
                        114 -61 19 -58 1754 -58 1735 0 1640 -3 1754 58 65 35 153 123 188 188 49 92
                        58 148 58 381 l0 213 208 0 c227 0 285 9 376 58 65 35 153 123 188 188 61 114
                        58 19 58 1754 0 1735 3 1640 -58 1754 -35 65 -123 153 -188 188 -114 61 -18
                        58 -1759 57 -1356 0 -1598 -2 -1644 -15z m3116 -314 c87 -40 155 -108 198
                        -193 l35 -70 0 -1407 0 -1407 -35 -71 c-42 -84 -112 -152 -200 -193 -55 -27
                        -69 -29 -177 -29 l-118 0 0 1223 c0 1336 2 1279 -58 1391 -35 65 -123 153
                        -188 188 -112 60 -54 58 -1396 58 l-1228 0 0 123 c0 114 2 126 30 184 40 87
                        108 155 193 198 l70 35 1406 0 1406 0 62 -30z"/>
                    </g>
                </svg>`
    }
    else if (property == "objects" || property == "object") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="2 2 21 21" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.5144 1.12584C11.8164 0.958052 12.1836 0.958052 12.4856 1.12584L21.4845 6.12522C21.4921 6.12942 21.4996 6.13372 21.5071 
                    6.13813C21.8125 6.31781 22 6.64568 22 7V17C22 17.3632 21.8031 17.6978 21.4856 17.8742L12.4856 22.8742C12.1791 23.0445 11.8059 23.0416 
                    11.5022 22.8673L2.51436 17.874C2.19689 17.6977 2 17.3631 2 16.9999V7C2 6.64568 2.18749 6.3177 2.49287 6.13802L2.5073 6.13784L2.51436 
                    6.12584L11.5144 1.12584ZM12.0001 10.856L5.05923 6.99995L12 3.14396L18.9409 7L12.0001 10.856ZM4 8.69951V16.4115L11 20.3004V12.5884L4 
                    8.69951ZM13 12.5884V20.3005L20 16.4116V8.69951L13 12.5884Z" 
                    />
                </svg>`
    }
    else if (property == "email") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 -3 22 22" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.87 4h13.25C18.37 4 19 4.59 19 5.79v8.42c0 1.19-.63 1.79-1.88 1.79H3.87c-1.25 0-1.88-.6-1.88-1.79V5.79c0-1.2.63-1.79 1.88-1.79m6.62 
                    8.6l6.74-5.53c.24-.2.43-.66.13-1.07c-.29-.41-.82-.42-1.17-.17l-5.7 3.86L4.8 5.83c-.35-.25-.88-.24-1.17.17c-.3.41-.11.87.13 1.07z" 
                    />
                </svg>`
    }
    else if (property == "phone") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="0 -2 26 26" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.554 6.24L7.171 2.335c-.39-.45-1.105-.448-1.558.006L2.831 5.128c-.828.829-1.065 2.06-.586 3.047a29.207 29.207 0 0 0 13.561 13.58c.986.479
                     2.216.242 3.044-.587l2.808-2.813c.455-.455.456-1.174.002-1.564l-3.92-3.365c-.41-.352-1.047-.306-1.458.106l-1.364 1.366a.462.462 0 0 1-.553.088a14.557
                      14.557 0 0 1-5.36-5.367a.463.463 0 0 1 .088-.554l1.36-1.361c.412-.414.457-1.054.101-1.465"/" 
                    />
                </svg>`
    }
    else if (property == "number") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                    viewBox="100 0 900 900" xmlns="http://www.w3.org/2000/svg">
                    <path d="M508 280h-63.3c-3.3 0-6 2.7-6 6v340.2H433L197.4 282.6c-1.1-1.6-3-2.6-4.9-2.6H126c-3.3 0-6 2.7-6 6v464c0 3.3 2.7 6 
                    6 6h62.7c3.3 0 6-2.7 6-6V405.1h5.7l238.2 348.3c1.1 1.6 3 2.6 5 2.6H508c3.3 0 6-2.7 6-6V286c0-3.3-2.7-6-6-6m378 413H582c-4.4 
                    0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8m-152.2-63c52.9 0 95.2-17.2 126.2-51.7c29.4-32.9 44-75.8 
                    44-128.8c0-53.1-14.6-96.5-44-129.3c-30.9-34.8-73.2-52.2-126.2-52.2c-53.7 0-95.9 17.5-126.3 52.8c-29.2 33.1-43.4 75.9-43.4 128.7c0 
                    52.4 14.3 95.2 43.5 128.3c30.6 34.7 73 52.2 126.2 52.2m-71.5-263.7c16.9-20.6 40.3-30.9 71.4-30.9c31.5 0 54.8 9.6 71 29.1c16.4 20.3 
                    24.9 48.6 24.9 84.9c0 36.3-8.4 64.1-24.8 83.9c-16.5 19.4-40 29.2-71.1 29.2c-31.2 0-55-10.3-71.4-30.4c-16.3-20.1-24.5-47.3-24.5-82.6c.1-35.8 8.2-63 24.5-83.2" 
                    />
                </svg>`
    }
    else if (property == "date") {
        return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                        viewBox="1 -1 23 23" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 8.5v9.25A3.25 3.25 0 0 1 17.75 21H6.25A3.25 3.25 0 0 1 3 17.75V8.5zm-7.005 2.195q-.996 0-1.582.532t-.586 1.441q0 
                        .522.266.93q.267.408.725.642a1.94 1.94 0 0 0-.85.698a1.8 1.8 0 0 0-.302 1.026q0 .933.637 1.484Q12.94 18 14 18q1.054 0 
                        1.69-.55q.634-.549.634-1.486q0-.566-.3-1.016a2.03 2.03 0 0 0-.857-.708q.464-.234.732-.642q.27-.408.269-.93q0-.908-.586-1.44q-.586-.533-1.587-.533m-3.775.074h-.152l-2.773 
                        1.02v1.001l1.743-.596v5.708h1.182zm3.77 3.96q.518 0 .833.324q.315.325.315.852q0 
                        .543-.3.845q-.3.303-.838.303q-.537 0-.842-.313q-.306-.312-.306-.835q0-.532.31-.854t.828-.322m.005-3.081q.454 0 
                        .723.3t.268.764q0 .488-.266.776q-.265.288-.72.288t-.72-.288q-.267-.287-.266-.776q0-.493.263-.779q.264-.285.718-.285M17.75 3A3.25 3.25 0 0 1 21 
                        6.25V7H3v-.75A3.25 3.25 0 0 1 6.25 3z" 
                        />
                    </svg>`
    }

    // multi_select or other
    return `<svg style="margin-bottom: 10px; height: 16px; width: 16px; fill: var(--section-title-color)"
                viewBox="0 -2 13 13" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 1C3 0.447715 3.44772 0 4 0L11 0C11.5523 0 12 0.447716 12 1C12 1.55228 11.5523 2 11 2L4 2C3.44772 
                    2 3 1.55228 3 1ZM3 5C3 4.44771 3.44772 4 4 4L11 4C11.5523 4 12 4.44772 12 5C12 5.55228 11.5523 6 11 6L4 6C3.44772 
                    6 3 5.55228 3 5ZM3 9C3 8.44771 3.44772 8 4 8L11 8C11.5523 8 12 8.44772 12 9C12 9.55228 11.5523 10 11 10L4 10C3.44772 10 3 9.55228 
                    3 9ZM1 2C0.447715 2 0 1.55228 0 1C0 0.447715 0.447715 0 1 0C1.55228 0 2 0.447715 2 1C2 1.55228 1.55228 2 1 2ZM1 6C0.447715 6 0 
                    5.55228 0 5C0 4.44772 0.447715 4 1 4C1.55228 4 2 4.44772 2 5C2 5.55228 1.55228 6 1 6ZM1 10C0.447715 10 0 9.55228 0 9C0 8.44772 
                    0.447715 8 1 8C1.55228 8 2 8.44772 2 9C2 9.55228 1.55228 10 1 10Z" 
                />
            </svg>`
}

// Initialize

if (document.readyState === "complete" || document.readyState === "interactive") {
    localPopapInited();
} else {
    document.addEventListener("DOMContentLoaded", localPopapInited);
}

async function localPopapInited() {
    // DOM Elements
    const elements = {
        status: document.getElementById('status'),
        authSection: document.getElementById('authSection'),
        mainSection: document.getElementById('mainSection'),
        settingsSection: document.getElementById('settingsSection'),
        createFormSection: document.getElementById('createFormSection'),
        propertiesSection: document.getElementById('propertiesSection'),
        objectTemplateSection: document.getElementById('objectTemplateSection'),
        settingsButton: document.getElementById('settingsButton'),
        mainSectionButton: document.getElementById('mainSectionButton'),
        mainSectionButton2: document.getElementById('mainSectionButton2'),
        mainSectionButton3: document.getElementById('mainSectionButton3'),
        mainSectionButton4: document.getElementById('mainSectionButton4'),
        saveFormBtn: document.getElementById('saveFormBtn'),
        createFormButton: document.getElementById('createFormButton'),
        apiKeyInput: document.getElementById('apiKeyInput'),
        propertiesListHandler: document.getElementById('propertiesListHandler'),
        connectBtn: document.getElementById('connectBtn'),
        disconnectBtn: document.getElementById('disconnectBtn'),
        spaceSelect: document.getElementById('spaceSelect'),
        collectionSection: document.getElementById('collectionSection'),
        typeSection: document.getElementById('typeSection'),
        collectionsList: document.getElementById('collectionsList'),
        objectName: document.getElementById('objectName'),
        typeSelect: document.getElementById('typeSelect'),
        objectTemplateSectionSelect: document.getElementById('objectTemplateSectionSelect'),
        saveObjectBtn: document.getElementById('saveObjectBtn'),
        saveObjectBtnText: document.getElementById('saveObjectBtnText'),
        appNameInput: document.getElementById('appNameInput'),
        startChallengeBtn: document.getElementById('startChallengeBtn'),
        codeSection: document.getElementById('codeSection'),
        codeInput: document.getElementById('codeInput'),
        verifyCodeBtn: document.getElementById('verifyCodeBtn'),
        handlerForLoadedForms: document.getElementById('handlerForLoadedForms'),
        confirmDeleteFormSection: document.getElementById('confirmDeleteFormSection'),
        deleteFormBtn: document.getElementById('deleteFormBtn'),
        themeSelect: document.getElementById('themeSelect'),
        openGitHubBtn: document.getElementById('openGitHubBtn'),
        languageSelect: document.getElementById('languageSelect'),
        colorInput: document.getElementById('colorInput'),
        objectNameToSave: document.getElementById('objectNameToSave'),
        saveObjectSection: document.getElementById('saveObjectSection'),
        propertiesSaveObjectListWithDefaultValueHandler: document.getElementById('propertiesSaveObjectListWithDefaultValueHandler'),
        propertiesSaveObjectListWithDefaultValueHandlerContent: document.getElementById('propertiesSaveObjectListWithDefaultValueHandlerContent'),
        propertiesSaveObjectListWithDefaultValueHandlerToggle: document.getElementById('propertiesSaveObjectListWithDefaultValueHandlerToggle'),
        propertiesSaveObjectListWithoutDefaultValueHandler: document.getElementById('propertiesSaveObjectListWithoutDefaultValueHandler'),
        propertiesSaveObjectListWithDefaultValueHandlerToggleText: document.getElementById('propertiesSaveObjectListWithDefaultValueHandlerToggleText'),
        propertiesSaveObjectListWithDefaultValueHandlerToggleSign: document.getElementById('propertiesSaveObjectListWithDefaultValueHandlerToggleSign'),
        collapseInputSettings: document.getElementById('collapseInputSettings'),
        objectSavedSection: document.getElementById('objectSavedSection'),
        OpenInAnytypeBtn: document.getElementById('OpenInAnytypeBtn'),
        OpenAnytypeBtn: document.getElementById('OpenAnytypeBtn'),
        SaveToAnytypeVersion: document.getElementById('SaveToAnytypeVersion'),
        FormNameInput: document.getElementById('FormNameInput'),
        FormNameInputSection: document.getElementById('FormNameInputSection'),
        createFormTipButton: document.getElementById('createFormTipButton'),
        blockedSection: document.getElementById('blockedSection'),
        blockedSectionText: document.getElementById('blockedSectionText'),
        loadingSection: document.getElementById('loadingSection'),
        whatDoOnStartSelect: document.getElementById('whatDoOnStartSelect'),
        zoomRangeValue: document.getElementById('zoomRangeValue'),
        zoomCurrentRange: document.getElementById('zoomCurrentRange'),
        zoomContainer: document.getElementById('zoomContainer'),
        heightRangeValue: document.getElementById('heightRangeValue'),
        heightCurrentRange: document.getElementById('heightCurrentRange'),
        widthRangeValue: document.getElementById('widthRangeValue'),
        widthCurrentRange: document.getElementById('widthCurrentRange')
    };

    const chromeTABS = await chrome.runtime.sendMessage({
        action: "GET_TABS"
    });

    function createTurndownService() {
        const service = new TurndownService({
            headingStyle: 'atx',
            hr: '---',
            bulletListMarker: '-',
            codeBlockStyle: 'fenced',
            emDelimiter: '_'
        });

        service.keep(['iframe', 'script', 'style']);

        service.addRule('figures', {
            filter: 'figure',
            replacement: (content, node) => {
                const img = node.querySelector('img');
                const caption = node.querySelector('figcaption');
                if (img) {
                    const alt = img.getAttribute('alt') || '';
                    const src = img.getAttribute('src') || '';
                    const captionText = caption ? caption.textContent : '';
                    return `

![${alt}](${src})
${captionText}

`;
                }
                return content;
            }
        });

        return service;
    }

    // Tab management
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;

            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
        });
    });

    function generateRandomId() {
        const now = new Date();

        //    : YYYYMMDDHHMMSS
        const dateTime = now.getFullYear().toString() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') +
            String(now.getHours()).padStart(2, '0') +
            String(now.getMinutes()).padStart(2, '0') +
            String(now.getSeconds()).padStart(2, '0');

        //  5- 
        const randomNumber = Math.floor(Math.random() * 100000)
            .toString()
            .padStart(5, '0');

        return dateTime + randomNumber;
    }

    // Show status message
    function showStatus(message, type = 'info') {
        elements.status.textContent = message;
        elements.status.className = `status ${type}`;
        elements.status.classList.remove('hidden');

        if (type !== 'error') {
            setTimeout(() => {
                elements.status.classList.add('hidden');
            }, 3000);
        }
    }

    function consoleLog(messageText, ...argsL) {
        chrome.runtime.sendMessage({ message: messageText, type: "log", args: argsL });
    }

    function consoleError(messageText, ...argsL) {
        chrome.runtime.sendMessage({ message: messageText, type: "error", args: argsL });
    }

    function UpdateTheTranslation() {
        loadLocalization().then(() => {
            document.querySelectorAll('[data-locale-key]').forEach(el => {
                const key = el.dataset.localeKey;
                el.textContent = Localize(key, state.language);
            });
            document.querySelectorAll('[data-locale-placeholder]').forEach(el => {
                const key = el.dataset.localePlaceholder;
                el.placeholder = Localize(key, state.language);
            });

            chrome.runtime.sendMessage({
                action: "CreateContextMenusButtons",
                menuOption1: Localize("SaveToAnytypemenuOption1", state.language),
                menuOption2: Localize("SaveSelectedTextAnytypeOption2", state.language)
            });
        });
    }

    window.LocalizeGlobal = function (key) {
        return Localize(key, state.language);
    }

    //#region Work with WebPage

    // To add a new page property, you need to add its object to the WebPagePropierties sheet and also add processing 
    // in the method document.addEventListener('DOMContentLoaded', async () => {

    let WebPagePropierties = [
        { id: "tab_title", nameKey: "tab_title", value: "null o_O" },
        { id: "page_url", nameKey: "page_url", value: "null o_O" },
        { id: "page_image", nameKey: "page_image", value: "null o_O" },
        { id: "page_description", nameKey: "page_description", value: "null o_O" },
        { id: "page_content", nameKey: "page_content", value: "" },
        { id: "selected_text_page", nameKey: "selected_text_page", value: "" }
    ];

    try {
        await loadState();

        if (state.apiKey) {
            await loadSpaces(true);
            showLoadingSection();
        }

        // Get current tab info
        const [tab] = chromeTABS;
        if (tab) {
            WebPagePropierties.find(p => p.id == "tab_title").value = tab.title || '';
            WebPagePropierties.find(p => p.id == "page_url").value = tab.url || '';

            const result = await chrome.runtime.sendMessage({
                action: "executeScript_findLargestVisibleImage",
                target: { tabId: tab.id }
            });

            const largestImgSrc = result[0].result;
            consoleLog("largestImgSrc: " + largestImgSrc);

            WebPagePropierties.find(p => p.id == "page_image").value = largestImgSrc || '';

            const resultDescription = await chrome.runtime.sendMessage({
                action: "executeScript_findDescription",
                target: { tabId: tab.id },
            });

            consoleLog("Founded description: " + resultDescription[0].result);

            WebPagePropierties.find(p => p.id == "page_description").value = resultDescription[0].result || '';

            const resultExtractPageText = await chrome.runtime.sendMessage({
                action: "executeScript_extractPageText",
                target: { tabId: tab.id },
            });

            if (turndownService == undefined)
                turndownService = createTurndownService();

            let markdown = turndownService.turndown(resultExtractPageText[0].result);

            // Post-processing: Collapse multiple newlines (3+) into max 2
            markdown = markdown.replace(/\n{3,}/g, '\n\n').trim();

            consoleLog("Founded content: " + markdown);

            WebPagePropierties.find(p => p.id == "page_content").value = markdown || '';
        }

        elements.SaveToAnytypeVersion.innerText = chrome.runtime.getManifest().version;

        // Check for selected text from context menu
        await loadSelectedText();
    }
    catch (error) {
        console.error(error);
        URLWasRejected = true;
        showBlockSection(true);
    }

    function GetPagePropiertie(propiertie_key) {
        return WebPagePropierties.find(p => p.id == propiertie_key).value;
    }

    // Load selected text from storage
    async function loadSelectedText() {
        try {
            const result = await chrome.storage.local.get(['selectedText', 'selectedTextTimestamp']);

            if (result.selectedText) {
                // Check if the selection is recent (within last 5 seconds)
                const now = Date.now();
                const timestamp = result.selectedTextTimestamp || 0;

                if (now - timestamp < 5000) {
                    // Format the selected text as markdown quote
                    const formattedText = result.selectedText
                        .split('\n')
                        .map(line => `${line}`)
                        .join('\n');

                    WebPagePropierties.find(p => p.id == "selected_text_page").value = formattedText || '';

                    // Clear the stored text
                    await chrome.storage.local.remove(['selectedText', 'selectedTextTimestamp']);

                    // Show a brief notification
                    showStatus(Localize("SelectedTextHasBeenAdded", state.language), 'success');
                }
            }
        } catch (error) {
            console.error(error);
            consoleError('Selected text could not be loaded: ', error.messsage);
        }
    }

    //#endregion

    //#region Themes

    function isHexColor(str) {
        return /^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{4}|[A-Fa-f0-9]{8})$/.test(str);
    }

    function ChangeTheme() {
        linkCSS = document.documentElement;

        if (state.theme === "dark") { // dark mode
            linkCSS.style.setProperty('--background', '#1a1a1a');
            linkCSS.style.setProperty('--background-focus', '#1a1a1a');
            linkCSS.style.setProperty('--input-text-color', '#e0e0e0');
            linkCSS.style.setProperty('--section-title-color', '#888888');
            linkCSS.style.setProperty('--text-color', '#e0e0e0');
            linkCSS.style.setProperty('--text-color-inverted', '#080808');
            linkCSS.style.setProperty('--back-color', '#0f0f0f');
            linkCSS.style.setProperty('--color1', '#101010');
            linkCSS.style.setProperty('--color2', '#070707');
            linkCSS.style.setProperty('--color3', '#1a1a1a');
            linkCSS.style.setProperty('--color4', '#333333');
            linkCSS.style.setProperty('--color5', '#363636');
            linkCSS.style.setProperty('--card-color', '#000000');
            linkCSS.style.setProperty('--icon-brightness', '255');
        }
        else { // light mode
            linkCSS.style.setProperty('--background', '#ffffff');
            linkCSS.style.setProperty('--background-focus', '#ecececff');
            linkCSS.style.setProperty('--input-text-color', '#080808');
            linkCSS.style.setProperty('--section-title-color', '#080808');
            linkCSS.style.setProperty('--text-color', '#080808');
            linkCSS.style.setProperty('--text-color-inverted', '#e0e0e0');
            linkCSS.style.setProperty('--back-color', '#ebebeb');
            linkCSS.style.setProperty('--color1', '#ddd');
            linkCSS.style.setProperty('--color2', '#fff');
            linkCSS.style.setProperty('--color3', '#f9f9f9');
            linkCSS.style.setProperty('--color4', '#b7b7b7');
            linkCSS.style.setProperty('--color5', '#f2f2f2');
            linkCSS.style.setProperty('--card-color', '#ffffff');
            linkCSS.style.setProperty('--icon-brightness', '0');
        }

        linkCSS.style.setProperty('--accent-color', state.accentColor);
        elements.colorInput.jscolor.fromString(state.accentColor);

        elements.zoomRangeValue.value = state.zoom;
        elements.zoomContainer.style.zoom = state.zoom;
        elements.zoomCurrentRange.textContent = state.zoom;

        elements.heightRangeValue.value = state.height;
        elements.heightCurrentRange.textContent = state.height;

        elements.widthRangeValue.value = state.width;
        elements.widthCurrentRange.textContent = state.width;
    }

    elements.colorInput.addEventListener("change", () => {
        consoleLog("Selected color:", elements.colorInput.value);


        if (isHexColor(elements.colorInput.value)) {
            state.accentColor = elements.colorInput.value;
            ChangeTheme();
            saveState();
        }
        else if (isHexColor("#" + elements.colorInput.value)) {

            elements.colorInput.jscolor.fromString("#" + elements.colorInput.value);

            state.accentColor = elements.colorInput.value;
            ChangeTheme();
            saveState();
        }
        else {
            showStatus(Localize('ColorInvalid', state.language), 'error');
        }
    });

    //#endregion

    //#region load and save data

    // Load saved state
    async function loadState() {
        const saved = await chrome.storage.local.get(
            ['apiKey', 'selectedSpaceId', 'theme', 'language', 'accentColor',
                'whatDoOnStart', 'LastUsedForm', 'zoom', 'height', 'width',
                'collapseOnOpenForm', 'forms']
        );

        if (saved.apiKey) {
            state.apiKey = saved.apiKey;
        }

        if (saved.selectedSpaceId) {
            state.selectedSpaceId = saved.selectedSpaceId;
        }

        if (saved.theme) {
            state.theme = saved.theme;
        }
        else {
            state.theme = 'dark';
        }

        if (saved.language) {
            state.language = saved.language;
        }
        else {
            state.language = "en";

            loadLocalization().then(() => {
                const langShort = (navigator.language || navigator.userLanguage).split('-')[0];

                const languageExist = CheckLanguageExist(langShort);

                consoleLog("language: " + langShort + " , language exist: " + languageExist);

                if (languageExist)
                    state.language = langShort;

                UpdateTheTranslation();
            });
        }

        if (saved.accentColor) {
            state.accentColor = saved.accentColor;
        }
        else {
            state.accentColor = DEFAULT_ACCENT_COLOR;
        }

        if (saved.whatDoOnStart) {
            state.whatDoOnStart = saved.whatDoOnStart;
        }
        else {
            state.whatDoOnStart = "Nothing";
        }

        if (saved.LastUsedForm) {
            state.LastUsedForm = saved.LastUsedForm;
        }
        else {
            state.LastUsedForm = "null";
        }

        if (saved.zoom) {
            state.zoom = saved.zoom;
        }
        else {
            state.zoom = 1;
        }

        if (saved.height) {
            state.height = saved.height;
        }
        else {
            state.height = 70;
        }

        if (saved.width) {
            state.width = saved.width;
        }
        else {
            state.width = 24;
        }

        if (saved.collapseOnOpenForm) {
            state.collapseOnOpenForm = saved.collapseOnOpenForm;
        }
        else {
            state.collapseOnOpenForm = "false";
        }

        if (saved.forms) {
            state.forms = saved.forms;
        }
        else {
            state.forms = [];
        }

        loadLocalization().then(() => {
            window.dispatchEvent(new Event('LocalizeGlobalReady'));
        });

        consoleLog("load saved state: ", saved);
        ChangeTheme();

        UpdateTheTranslation();
    }

    // Save state
    async function saveState() {
        await chrome.storage.local.set({
            apiKey: state.apiKey,
            selectedSpaceId: state.selectedSpaceId,
            theme: state.theme,
            language: state.language,
            accentColor: state.accentColor,
            whatDoOnStart: state.whatDoOnStart,
            LastUsedForm: state.LastUsedForm,
            zoom: elements.zoomRangeValue.value,
            height: elements.heightRangeValue.value,
            width: elements.widthRangeValue.value,
            collapseOnOpenForm: elements.collapseInputSettings.checked.toString(),
            forms: state.forms
        });

        consoleLog("state saved");
    }

    //#endregion

    //#region settings

    elements.collapseInputSettings.addEventListener('input', () => {
        state.collapseOnOpenForm = elements.collapseInputSettings.checked.toString();

        saveState();

        ChangeTheme();
    });

    elements.zoomRangeValue.addEventListener('input', () => {
        elements.zoomCurrentRange.textContent = elements.zoomRangeValue.value;

        state.zoom = elements.zoomRangeValue.value;

        saveState();

        ChangeTheme();
    });

    elements.heightRangeValue.addEventListener('input', () => {
        elements.heightCurrentRange.textContent = elements.heightRangeValue.value;

        state.height = elements.heightRangeValue.value;

        saveState();

        ChangeTheme();
    });

    elements.widthRangeValue.addEventListener('input', () => {
        elements.widthCurrentRange.textContent = elements.widthRangeValue.value;

        state.width = elements.widthRangeValue.value;

        saveState();

        ChangeTheme();
    });

    elements.themeSelect.addEventListener('change', async (e) => {
        state.theme = themeSelectChoices.getValue(true);

        saveState();

        ChangeTheme();
    });

    elements.languageSelect.addEventListener('change', async (e) => {
        state.language = languageSelectChoices.getValue(true);

        UpdateTheTranslation();

        saveState();
    });

    elements.whatDoOnStartSelect.addEventListener('change', async (e) => {
        state.whatDoOnStart = whatDoOnStartSelectChoices.getValue(true);

        saveState();
    });

    //#endregion

    //#region connect and disconnect Anytype

    // API Key Connection
    elements.connectBtn.addEventListener('click', async () => {
        const apiKey = elements.apiKeyInput.value.trim();

        if (!apiKey) {
            showStatus(Localize('PleaseEnterYourAPIKey', state.language), 'error');
            return;
        }

        elements.connectBtn.innerHTML = ('<span class="loading"></span> ' + Localize('Connecting', state.language));
        elements.connectBtn.disabled = true;

        try {
            // Test the API key
            const response = await fetch(`${API_BASE_URL}/spaces`, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (response.ok) {
                const responseData = await response.json();
                consoleLog('Initial API test response:', responseData);

                // Check if we got valid data
                if (responseData && (responseData.data || Array.isArray(responseData))) {
                    state.apiKey = apiKey;
                    await saveState();
                    showStatus(Localize('Successfullyonnected', state.language), 'success');
                    showMainSection();
                    await loadSpaces(true);
                } else {
                    showStatus(Localize('APIResponseIsInAnUnexpectedFormat', state.language), 'error');
                }
            } else {
                const errorText = await response.text();
                console.error('API Key test failed:', response.status + " ," + errorText);
                consoleError('API Key test failed:', response.status + " ," + errorText);
                showStatus(Localize('InvalidAPIKey', state.language) + response.status, 'error');
            }

            UpdateTheTranslation();
        } catch (error) {
            console.error(error);
            consoleError('Connection error:', error.messsage);
            showStatus(Localize('ConnectionError', state.language) + error.message, 'error');
        } finally {
            elements.connectBtn.innerHTML = 'Connect';
            elements.connectBtn.disabled = false;
        }
    });

    // Challenge Authentication
    elements.startChallengeBtn.addEventListener('click', async () => {
        const appName = elements.appNameInput.value.trim() || 'Save To Anytype';

        elements.startChallengeBtn.innerHTML = ('<span class="loading"></span> ' + Localize('ChallengeIsStarting', state.language));
        elements.startChallengeBtn.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/challenges`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Anytype-Version': API_VERSION
                },
                body: JSON.stringify({ app_name: appName })
            });

            if (response.ok) {
                const data = await response.json();
                state.challengeId = data.challenge_id;
                elements.codeSection.classList.remove('hidden');
                showStatus(Localize('Enter4digit', state.language), 'info');
                elements.codeInput.focus();
            } else {
                showStatus(Localize('ChallengeCouldNotBeStarted', state.language), 'error');
            }
        } catch (error) {
            showStatus(Localize('ConnectionError', state.language) + error.message, 'error');
        } finally {
            elements.startChallengeBtn.innerText = Localize('StartChallenge', state.language);
            elements.startChallengeBtn.disabled = false;
        }
    });

    // Verify Challenge Code
    elements.verifyCodeBtn.addEventListener('click', async () => {
        const code = elements.codeInput.value.trim();

        if (!code || code.length !== 4) {
            showStatus(Localize('Enter4digit', state.language), 'error');
            return;
        }

        elements.verifyCodeBtn.innerHTML = ('<span class="loading"></span> ' + Localize('Verifying', state.language));
        elements.verifyCodeBtn.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/api_keys`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Anytype-Version': API_VERSION
                },
                body: JSON.stringify({
                    challenge_id: state.challengeId,
                    code: code
                })
            });

            if (response.ok) {
                const data = await response.json();
                state.apiKey = data.api_key;
                await saveState();
                showStatus(Localize('Successfullyonnected', state.language), 'success');
                showMainSection();
                await loadSpaces(true);
            } else {
                showStatus(Localize('CodeCouldNotBeVerified', state.language), 'error');
            }
        } catch (error) {
            showStatus(Localize('ConnectionError', state.language) + error.message, 'error');
        } finally {
            elements.verifyCodeBtn.innerHTML = 'Verify';
            elements.verifyCodeBtn.disabled = false;
        }
    });

    // Disconnect
    elements.disconnectBtn.addEventListener('click', async () => {
        state.apiKey = null;
        selectedSpaceId = null;
        await chrome.storage.local.remove(['apiKey', 'selectedSpaceId']);

        authSection();
        elements.apiKeyInput.value = '';
        elements.codeInput.value = '';
        elements.codeSection.classList.add('hidden');

        showStatus(Localize('ConnectionLost', state.language), 'info');
    });

    //#endregion

    //#region Change windows

    function showBlockSection(URLRejected) {
        consoleLog('showBlockSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');
        elements.blockedSection.classList.remove('hidden');

        if (URLRejected) {
            elements.blockedSectionText.innerText = Localize("blockedSectionURLRejected", state.language);
            elements.OpenAnytypeBtn.classList.add('hidden');
        }
        else {
            elements.blockedSectionText.innerText = Localize("blockedSectionAnytypeNotRunning", state.language);
            elements.OpenAnytypeBtn.classList.remove('hidden');
        }
    }

    async function showMainSection() {
        consoleLog('showMainSection');

        LoadFormsForMainSection();

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.remove('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');
    }

    async function showLoadingSection() {
        consoleLog('showLoadingSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.remove('hidden');
    }

    function showCreateFormSection() {
        consoleLog('showCreateFormSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.remove('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');

        loadSpaces(false);
    }

    function settingsSection() {
        consoleLog('settingsSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.remove('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');

        if (themeSelectChoices === null) {
            themeSelectChoices = new Choices(elements.themeSelect, {
                removeItemButton: false,
                searchEnabled: false,
                shouldSort: false,
            });
        }

        themeSelectChoices.setChoiceByValue(state.theme);

        if (whatDoOnStartSelectChoices === null) {
            whatDoOnStartSelectChoices = new Choices(elements.whatDoOnStartSelect, {
                removeItemButton: false,
                searchEnabled: false,
                shouldSort: false,
            });
        }

        whatDoOnStartSelectChoices.setChoiceByValue(state.whatDoOnStart);

        if (languageSelectChoices === null) {
            const langs = GetLanguages();

            const choicesData = langs.map(lang => {
                return {
                    value: lang.languageCode,
                    label: lang.languageName,
                    customProperties: {
                        img: `https://flagsapi.com/${lang.countryCode}/flat/64.png`
                    }
                };
            });

            languageSelectChoices = new Choices(elements.languageSelect, {
                removeItemButton: false,
                searchEnabled: false,
                shouldSort: false,
                choices: choicesData
            });

            choicesData.forEach(x => {
                const url = x.customProperties.img;

                const style = document.createElement("style");
                style.textContent = `
            .choices__item[data-value="${x.value}"]::after {
                background-image: url("${url}");
            }
            `;
                document.head.appendChild(style);
            });
        }

        languageSelectChoices.setChoiceByValue(state.language);

        elements.collapseInputSettings.checked = state.collapseOnOpenForm === "true";
        //elements.collapseInputSettings.value = state.collapseOnOpenForm;
    }

    function authSection() {
        consoleLog('authSection');

        elements.authSection.classList.remove('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');
    }

    function showConfirmDeleteFormSection(form) {
        consoleLog('showConfirmDeleteFormSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.remove('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.loadingSection.classList.add('hidden');

        elements.deleteFormBtn.addEventListener('click', async () => {
            DeleteForm(form);
        });
    }

    function showSaveObjectSection(form) {
        consoleLog('showSaveObjectSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.remove('hidden');
        elements.loadingSection.classList.add('hidden');

        loadObjectTypeToSave(form);
    }

    function showobjectSavedSection() {
        consoleLog('showobjectSavedSection');

        elements.authSection.classList.add('hidden');
        elements.mainSection.classList.add('hidden');
        elements.createFormSection.classList.add('hidden');
        elements.settingsSection.classList.add('hidden');
        elements.confirmDeleteFormSection.classList.add('hidden');
        elements.saveObjectSection.classList.add('hidden');
        elements.objectSavedSection.classList.remove('hidden');
        elements.loadingSection.classList.add('hidden');
    }

    elements.createFormButton.addEventListener('click', async () => {
        showCreateFormSection();
    });

    elements.settingsButton.addEventListener('click', async () => {
        settingsSection();
    });

    elements.mainSectionButton.addEventListener('click', async () => {
        showMainSection();
    });

    elements.mainSectionButton2.addEventListener('click', async () => {
        showMainSection();
    });

    elements.mainSectionButton3.addEventListener('click', async () => {
        showMainSection();
    });

    elements.mainSectionButton4.addEventListener('click', async () => {
        showMainSection();
    });

    elements.openGitHubBtn.addEventListener('click', async () => {
        open("https://github.com/lazjedi/Save-to-Anytype", "_blank");
    });

    elements.OpenAnytypeBtn.addEventListener('click', async () => {
        open("Anytype://", "_blank");
    });

    //#endregion

    //#region Create form

    function SetNameForForm() {
        const emoji = selectedType.icon?.format === "emoji" ? selectedType.icon?.emoji : "";

        elements.FormNameInput.value = emoji + " " + selectedType.name + " | " + SelectedSpaceName;
    }

    elements.saveFormBtn.addEventListener('click', async () => {
        try {
            let propertiesList = [];

            for (let index = 0; index < propertiesListForSaving.length; index++) {
                const obj = propertiesListForSaving[index];

                propertiesList.push(
                    {
                        AnytypeProperty: obj?.AnytypeProperty,
                        SelectedValueByUser: obj?.choice?.getValue(true)
                    }
                );
            }

            const form = {
                formId: generateRandomId(),
                formName: elements.FormNameInput?.value,
                spaceId: selectedSpaceId,
                type: selectedType,
                collectionId: collectionSelectChoices?.getValue(true),
                templateId: templateSelectChoices?.getValue(true),
                properties: propertiesList
            }

            consoleLog("saving form: ", form);

            state.forms.push(form);

            saveState();
            showMainSection();
        }
        catch (error) {
            console.log(error);
        }
    });

    // Space selection change
    elements.spaceSelect.addEventListener('change', async (e) => {
        selectedSpaceId = e.target.value;

        SelectedSpaceName = AllSpaces.find(s => s.id == selectedSpaceId).name;

        if (typeSelectChoices !== null)
            typeSelectChoices.destroy();

        if (collectionSelectChoices !== null)
            collectionSelectChoices.destroy();

        if (templateSelectChoices !== null)
            templateSelectChoices.destroy();

        elements.objectTemplateSection.classList.add('hidden');

        if (selectedSpaceId) {
            elements.typeSection.classList.remove('hidden');
            elements.saveFormBtn.classList.remove('hidden');
            elements.FormNameInputSection.classList.remove('hidden');

            await saveState();
            await loadCollections(selectedSpaceId);
            await loadTypes(selectedSpaceId);
        } else {
            selectedSpaceId = null;
            elements.collectionSection.classList.add('hidden');
            elements.typeSection.classList.add('hidden');
            elements.FormNameInputSection.classList.add('hidden');
            elements.propertiesSection.classList.add('hidden');
            elements.saveFormBtn.classList.add('hidden');
        }
    });

    // Type selection change
    elements.typeSelect.addEventListener('change', (e) => {
        for (let i = 0; i < CashedTypes.length; i++) {
            const type = CashedTypes[i];
            if (e.target.value === type.key) {
                selectedType = type;
                break;
            }
        }

        if (templateSelectChoices !== null)
            templateSelectChoices.destroy();

        elements.objectTemplateSection.classList.add('hidden');

        loadObjectTemplates(selectedType.id);
        loadObjectProperties();

        SetNameForForm();

        elements.propertiesSection.classList.remove('hidden');
        elements.objectTemplateSection.classList.add('hidden');
    });

    async function loadSpaces(needToShowMainSection) {
        loadLocalization().then(async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/spaces`, {
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Anytype-Version': API_VERSION
                    }
                });

                selectedSpaceId = null;

                selectedType = null;

                propertiesListSpawned = [];
                allObjects = [];

                CashedTypes = null;

                elements.objectTemplateSection.classList.add('hidden');
                elements.collectionSection.classList.add('hidden');
                elements.typeSection.classList.add('hidden');
                elements.FormNameInputSection.classList.add('hidden');
                elements.propertiesSection.classList.add('hidden');
                elements.saveFormBtn.classList.add('hidden');

                if (spaceSelectChoices !== null)
                    spaceSelectChoices.destroy();

                elements.spaceSelect.innerHTML = '<option value="">' + Localize("SelectSpace", state.language) + '</option>';

                if (response.ok) {
                    const responseData = await response.json();
                    consoleLog('Spaces API response:', responseData);

                    let spaces = responseData.data || responseData.spaces || responseData.items || [];

                    if (Array.isArray(responseData)) {
                        spaces = responseData;
                    }

                    if (!Array.isArray(spaces)) {
                        console.error('Unexpected spaces format:', responseData);
                        consoleError('Unexpected spaces format:', responseData);
                        showStatus(Localize('SpaceListInUnexpectedFormat', state.language), 'error');
                        return;
                    }

                    if (spaces.length === 0) {
                        showStatus(Localize('NoSpaceFound', state.language), 'error');
                        return;
                    }

                    spaces.forEach(space => {
                        const option = document.createElement('option');
                        option.value = space.id;
                        option.textContent = space.name || space.title || space.id || Localize('UntitledSpace', state.language);
                        if (space.id === selectedSpaceId) {
                            option.selected = true;
                        }
                        elements.spaceSelect.appendChild(option);
                    });

                    AllSpaces = spaces;

                    spaceSelectChoices = new Choices(document.getElementById("spaceSelect"), {
                        removeItemButton: false,
                        searchEnabled: true,
                        shouldSort: false,
                    });

                    if (!URLWasRejected && needToShowMainSection)
                        showMainSection();

                    if (selectedSpaceId) {
                        await loadCollections(selectedSpaceId);
                        await loadTypes(selectedSpaceId);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Space load error:', response.status + " ," + errorText);
                    consoleError('Space load error:', response.status + " ," + errorText);
                    showStatus(Localize('SpaceListCouldntBeLoaded', state.language) + response.status, 'error');
                }
            } catch (error) {
                console.error(error);
                consoleError('Space load exception:', error.messsage);
                showStatus(Localize('SpaceListCouldntBeLoaded', state.language) + error.message, 'error');
                showBlockSection(false);
            }
        });
    }

    async function loadTypes() {
        try {
            consoleLog('Loading types for space:', selectedSpaceId);

            // Update type select dropdown
            elements.typeSelect.innerHTML = '';

            const typesResponse = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/types`, {
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (typesResponse.ok) {
                const data = await typesResponse.json();
                consoleLog('Types API response:', data);

                let types = data.data || data.types || (Array.isArray(data) ? data : []);

                if (!Array.isArray(types)) {
                    console.error('Unexpected types format:', data);
                    consoleError('Unexpected types format:', data);
                    types = [];
                }

                if (typeSelectChoices !== null)
                    typeSelectChoices.destroy();

                elements.typeSelect.innerHTML = ``;

                if (types.length === 0) {
                    // Fallback to default types
                    elements.typeSelect.innerHTML = `
                    <option value="page" selected>Page</option>
                    <option value="note">Note</option>
                    <option value="task">Task</option>
                    <option value="bookmark">Bookmark</option>
                `;
                    consoleLog('No types found, using defaults');
                } else {
                    consoleLog('Found types:', types.length);

                    // Sort types: put common ones first
                    const commonTypes = ['page', 'note', 'task', 'bookmark'];
                    const sortedTypes = types.sort((a, b) => {
                        const aKey = a.key || a.type_key || '';
                        const bKey = b.key || b.type_key || '';
                        const aIndex = commonTypes.indexOf(aKey);
                        const bIndex = commonTypes.indexOf(bKey);

                        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                        if (aIndex !== -1) return -1;
                        if (bIndex !== -1) return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    });

                    CashedTypes = sortedTypes;

                    sortedTypes.forEach(type => {
                        const option = document.createElement('option');
                        const typeKey = type.key || type.type_key || type.id;
                        const typeName = type.name || type.title || typeKey;

                        option.value = typeKey;
                        option.textContent = typeName;

                        elements.typeSelect.appendChild(option);
                    });

                    selectedType = sortedTypes[0];

                    SetNameForForm();
                }

                typeSelectChoices = new Choices(document.getElementById("typeSelect"), {
                    removeItemButton: false,
                    searchEnabled: true,
                    shouldSort: false,
                });

                loadObjectProperties();
                loadObjectTemplates(selectedType.id);

                elements.propertiesSection.classList.remove('hidden');

            } else {
                console.error('Types load error:', typesResponse.status);
                consoleError('Types load error:', typesResponse.status);
                // Use default types on error
                elements.typeSelect.innerHTML = `
                <option value="page" selected>Page</option>
                <option value="note">Note</option>
                <option value="task">Task</option>
                <option value="bookmark">Bookmark</option>
            `;
            }
        } catch (error) {
            console.error(error);
            consoleError('Types could not be loaded:', error.messsage);
            // Use default types on error
            elements.typeSelect.innerHTML = `
            <option value="page" selected>Page</option>
            <option value="note">Note</option>
            <option value="task">Task</option>
            <option value="bookmark">Bookmark</option>
        `;
        }
    }

    async function loadCollections() {
        try {
            let collections = [];

            consoleLog('loadCollections for space id: ', selectedSpaceId);

            elements.collectionsList.innerHTML = '';

            // Primary method: Try lists endpoint
            try {
                const response = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/lists`, {
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Anytype-Version': API_VERSION
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    consoleLog('Lists endpoint response:', data);
                    collections = data.data || data.lists || (Array.isArray(data) ? data : []);

                    if (collections.length > 0) {
                        consoleLog('Found lists/sets:', collections.map(c => ({ id: c.id, name: c.name })));
                    }
                }
            } catch (e) {
                consoleLog('Lists endpoint error:', e);
            }

            // If no lists found, try getting all objects and filter for sets
            if (collections.length === 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/objects`, {
                        headers: {
                            'Authorization': `Bearer ${state.apiKey}`,
                            'Anytype-Version': API_VERSION
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const objects = data.data || data.objects || (Array.isArray(data) ? data : []);

                        const uniqueTypes = [...new Set(objects.map(o => o.type || o.type_key || 'unknown'))];
                        consoleLog('Unique object types in space:', uniqueTypes);

                        collections = objects.filter(obj => {
                            const isSet =
                                obj.type === 'set' ||
                                obj.type === 'collection' ||
                                obj.type_key === 'set' ||
                                obj.type_key === 'collection' ||
                                obj.layout === 'set' ||
                                obj.layout === 'collection' ||
                                obj.layout === 'gallery' ||
                                obj.layout === 'grid' ||
                                obj.layout === 'list' ||
                                obj.layout === 'kanban' ||
                                (obj.view && obj.view.type) ||
                                (obj.name && obj.name.toLowerCase().includes('set'));

                            if (isSet) {
                                consoleLog('Identified as set/collection:', obj.name, {
                                    id: obj.id,
                                    type: obj.type,
                                    type_key: obj.type_key,
                                    layout: obj.layout
                                });
                            }

                            return isSet;
                        });

                        allCollections = collections;
                    }
                } catch (e) {
                    consoleLog('Objects endpoint error:', e);
                }
            }

            if (collectionSelectChoices !== null)
                collectionSelectChoices.destroy();

            if (!collections || collections.length === 0) {
                elements.collectionsList.innerHTML = `
                <div class="collection-item" style="font-size: 12px; color: #666;">
                    Sets/Collections not founded<br>
                    <small style="color: #999;">You can also save directly to Space</small>
                </div>`;
                elements.collectionSection.classList.add('hidden');
            } else {
                elements.collectionSection.classList.remove('hidden');
                consoleLog('Displaying collections:', collections.length);

                elements.collectionsList.innerHTML = `
                <select id="collectionSelect">
                </select>`;

                allCollections = collections;

                collections.forEach(collection => {
                    const option = document.createElement('option');
                    const typeKey = collection.id;
                    const typeName = collection.name || collection.title || collection.id || 'Untitled Set';

                    option.value = typeKey;
                    option.textContent = typeName;

                    document.getElementById("collectionSelect").appendChild(option);
                });

                collectionSelectChoices = new Choices(document.getElementById("collectionSelect"), {
                    removeItemButton: true,
                    searchEnabled: true,
                    shouldSort: false,
                });

                collectionSelectChoices.removeActiveItems();
            }

            elements.typeSection.classList.remove('hidden');
            elements.FormNameInputSection.classList.remove('hidden');
        } catch (error) {
            consoleLog('Collections could not be loaded:', error);
            elements.collectionSection.classList.add('hidden');
            elements.collectionsList.innerHTML = `
            <div class="collection-item" style="font-size: 12px; color: #666;">
                Set/Collection yklenemedi<br>
                <small style="color: #999;">You can also save directly to Space</small>
            </div>`;
        }
    }

    async function loadObjectTemplates(selectedTypeId) {
        try {
            consoleLog('Loading Templates for space: ' + selectedSpaceId + " , type.id " + selectedTypeId);

            const typesTemplatesResponse = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/types/${selectedTypeId}/templates`, {
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (templateSelectChoices !== null)
                templateSelectChoices.destroy();

            // Update type select dropdown
            elements.objectTemplateSectionSelect.innerHTML = '';

            if (typesTemplatesResponse.ok) {
                const data = await typesTemplatesResponse.json();
                consoleLog('Types templates API response:', data);

                let typesTemplates = data.data || data.types || (Array.isArray(data) ? data : []);

                if (!Array.isArray(typesTemplates)) {
                    console.error('Unexpected types templates format:', data);
                    consoleError('Unexpected types templates format:', data);
                    typesTemplates = [];
                }

                if (typesTemplates.length === 0) {
                    consoleLog('No types templates found, using defaults');
                } else {
                    consoleLog('Found types templates:', typesTemplates.length);

                    // Sort types: put common ones first
                    let sortedTypes = []

                    sortedTypes = sortedTypes.concat(typesTemplates.sort((a, b) => {
                        const aKey = a.key || a.type_key || '';
                        const bKey = b.key || b.type_key || '';

                        if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                        if (aIndex !== -1) return -1;
                        if (bIndex !== -1) return 1;
                        return (a.name || '').localeCompare(b.name || '');
                    }));

                    allTemplatesForObject = sortedTypes;

                    consoleLog("sortedTypes: ", sortedTypes);

                    sortedTypes.forEach(type => {
                        const option = document.createElement('option');
                        const typeKey = type.key || type.type_key || type.id;
                        const typeName = type.name || type.title || typeKey;

                        option.value = typeKey;
                        option.textContent = typeName;

                        elements.objectTemplateSectionSelect.appendChild(option);
                    });

                    templateSelectChoices = new Choices(elements.objectTemplateSectionSelect, {
                        removeItemButton: true,
                        searchEnabled: true,
                        shouldSort: false,
                    });

                    templateSelectChoices.removeActiveItems();

                    elements.objectTemplateSection.classList.remove('hidden');
                }
            } else {
                console.error('Types templates load error:', typesTemplatesResponse.status);
                consoleError('Types templates load error:', typesTemplatesResponse.status);
            }
        } catch (error) {
            console.error(error);
            consoleError('Types templates could not be loaded:', error.messsage);
        }
    }

    async function loadAllObjects() {
        try {
            consoleLog("loading all objects");
            const response = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/objects?limit=300' `, {
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (response.ok) {
                allObjects = await response.json();
                allObjects = allObjects.data;
                consoleLog("all objects response ", allObjects);
            }
            else {
                allObjects = [];
            }

        } catch (error) {
            console.error(error);
            consoleError('loadAllObjects could not be loaded:', error.messsage);
        }
    }

    async function loadPropertieTags(propertyId) {
        try {
            const response = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/properties/${propertyId}/tags`, {
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (response.ok) {
                let result = await response.json();
                result = result.data;
                return result;
            }
            else {
                return [];
            }

        } catch (error) {
            console.error(error);
            consoleError('loadPropertieTags could not be loaded:', error.messsage);
        }
    }

    async function loadObjectProperties() {
        try {
            consoleLog('Loading Properties for space:', selectedSpaceId);

            elements.propertiesListHandler.innerHTML = "";
            propertiesListSpawned = [];

            let properties = [
                { object: "property", id: "nameId", key: "nameKeySaveToAnytype", name: Localize("NameOfObject", state.language), format: "text" },
                { object: "property", id: "objectBodyId", key: "objectBodyKeySaveToAnytype", name: Localize("objectBodyName", state.language), format: "text" }
            ];

            if (selectedType !== null && selectedType.properties !== null) {
                properties = properties.concat(selectedType.properties);

                let description = properties.find(p => p.key == "description");

                if (description === null || description === undefined)
                    properties.push(
                        { object: "property", id: "descriptionId", key: "description", name: Localize("Description", state.language), format: "text" }
                    );

                description = properties.find(p => p.key == "description");
                const index = properties.indexOf(description);
                if (index !== -1 && index !== 1) {
                    properties.splice(index, 1);
                    properties.splice(1, 0, description);
                }
            }

            consoleLog("currentTypeProperties: ", properties);

            propertiesListForSaving = [];

            for (const property of properties) {

                if (property.format === "files") continue; // images will be added later
                if (property.name === "Created by") continue; // we don't need this
                if (property.name === "Creation date") continue; // we don't need this

                let propertyHTML = document.createElement(`div`);

                if (property.format === "text" || property.format === "email"
                    || property.format === "number" || property.format === "url"
                    || property.format === "date" || property.format === "checkbox" || property.key === "description"
                    || property.format === "phone") {
                    propertyHTML.innerHTML = `
                                <div class="poperty-head">
                                    ` + GetPropertyIconSVG(property.format) + `
                                    <div class="section-title">` + property.name + `</div>
                                </div>
                                <div class="form-group">
                                    <select id="` + property.key + `">
                                        ${WebPagePropierties.map(o => `
                                            <option value="${o.id}">${Localize(o.nameKey, state.language) || o.id}</option>
                                            `).join("")}
                                    </select>
                                </div>
                            `;
                }
                else if (property.format === "objects") {
                    await loadAllObjects();

                    propertyHTML.innerHTML = `
                                <div class="poperty-head">
                                    ` + GetPropertyIconSVG(property.format) + `
                                    <div class="section-title">` + property.name + `</div>
                                </div>
                                <div class="form-group">
                                    <select id="` + property.key + `">
                                        ${allObjects.map(o => `
                                            <option value="${o.id}">${o.name || o.id}</option>
                                            `).join("")}
                                    </select>
                                </div>
                            `;
                }
                else if (property.format === "select" || property.format === "multi_select") {
                    const tags = await loadPropertieTags(property.id);

                    propertyHTML.innerHTML = `
                                <div class="poperty-head">
                                    ` + GetPropertyIconSVG(property.format) + `
                                    <div class="section-title">` + property.name + `</div>
                                </div>
                                <div class="form-group">
                                    <select id="` + property.key + `" ` + (property.format === "multi_select" ? `multiple` : ``) + `>
                                        ${tags.map(o => `
                                            <option value="${o.id}">${o.name || o.id}</option>
                                            `).join("")}
                                    </select>
                                </div>
                            `;
                }

                elements.propertiesListHandler.appendChild(propertyHTML);
                propertiesListSpawned.push(propertyHTML);

                const choice = new Choices(document.getElementById(property.key), {
                    removeItemButton: true,
                    searchEnabled: true,
                    shouldSort: false,
                });

                propertiesListForSaving.push(
                    { AnytypeProperty: property, choice: choice }
                );

                if (property.id === "nameId") {
                    choice.setChoiceByValue(property.id);
                }
                else {
                    choice.removeActiveItems();
                }

            }
        } catch (error) {
            console.error(error);
            consoleError('loadObjectProperties could not be loaded:', error.message);
        }
    }

    //#endregion

    //#region ManageFormsOnMainSection

    function LoadFormsForMainSection() {
        elements.handlerForLoadedForms.innerHTML = '';

        let firstFormInList = null;

        for (let index = 0; index < state.forms.length; index++) {
            const form = state.forms[index];

            const formObj = document.createElement('div');

            const name = (form.formName) || ((form.type.icon.format === "emoji" ? (form.type.icon.emoji + " ") : "") + form.type.name);

            if (index === 0)
                firstFormInList = form;

            formObj.innerHTML = `
            <div id="formObject` + form.formId + `" class="formObject flex-space-between">
                ` + ((state.forms.length !== 1) ? (`
                <div id="reorderFormButton` + form.formId + `" class="reorderFormButton"><div class="dots-icon"></div></div>
                `) : (``)) + `
                <button id="selectFormButton` + form.formId + `" class="btn-primary flex1">
                    <span id="selectFormButtonText` + form.formId + `">` + name + `</span>
                </button>
                <div id="deleteFormButton` + form.formId + `" class="trash-icon"></div>
            </div>
        `;

            elements.handlerForLoadedForms.appendChild(formObj);

            document.getElementById("deleteFormButton" + form.formId).addEventListener('click', async () => {
                showConfirmDeleteFormSection(form);
            });

            document.getElementById("selectFormButton" + form.formId).addEventListener('click', async () => {
                showSaveObjectSection(form);
            });
        }

        if (state.forms.length !== 1) {
            Sortable.create(
                elements.handlerForLoadedForms,
                {
                    animation: 150,
                    scroll: true,
                    handle: '.reorderFormButton',
                    onUpdate: function (evt) {
                        let formObjects = document.querySelectorAll(".formObject");

                        let newFormsOrder = [];

                        for (let index = 0; index < formObjects.length; index++) {
                            const formObj = formObjects[index];

                            const number = formObj.id.replace('formObject', '');

                            newFormsOrder.push(state.forms[number]);
                        }

                        state.forms = newFormsOrder;
                        saveState();
                    }
                }
            );
        }

        if (WasJustOpened) {
            WasJustOpened = false;

            if (state.whatDoOnStart == "OpenFirstForm" && firstFormInList !== null && firstFormInList !== "null") {
                setTimeout(() => {
                    showSaveObjectSection(firstFormInList);
                }, 0);
            }
            else if (state.whatDoOnStart == "OpenLastUsedForm" && state.LastUsedForm !== null && state.LastUsedForm !== undefined && state.LastUsedForm !== "null") {
                setTimeout(() => {
                    showSaveObjectSection(state.LastUsedForm);
                }, 0);
            }
        }
    }

    function DeleteForm(form) {
        const formInState = state.forms.find(f => f.formId == form.formId);

        const index = state.forms.indexOf(formInState);
        if (index !== -1) {
            state.forms.splice(index, 1);
        }

        saveState();
        loadState();

        showMainSection();
    }

    //#endregion

    //#region Save object to Anytype

    async function loadObjectTypeToSave(form) {
        try {
            consoleLog('Loading type object for save in space: ' + form.spaceId + ' , type.id: ' + form.type.id);

            elements.propertiesSaveObjectListWithoutDefaultValueHandler.innerHTML = '';
            elements.propertiesSaveObjectListWithDefaultValueHandlerContent.innerHTML = '';

            currentForm = form;
            propertiesListForSaving = [];

            const typesResponse = await fetch(`${API_BASE_URL}/spaces/${form.spaceId}/types/${form.type.id}`, {
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Anytype-Version': API_VERSION
                }
            });

            if (typesResponse.ok) {

                const data = await typesResponse.json();

                consoleLog('Type object for save response: ', data);
                consoleLog('Form to save this object: ', form);

                let properties = [
                    { format: 'text', id: 'nameId', key: 'nameKeySaveToAnytype', name: Localize("NameOfObject", state.language), object: 'property' }
                ];

                properties.push(
                    { format: "text", id: "objectBodyId", key: "objectBodyKeySaveToAnytype", name: Localize("objectBodyName", state.language), object: "property" }
                );

                properties = properties.concat(data.type.properties);

                const description = properties.find(p => p.key == "description");

                if (description === null || description === undefined) {
                    const index = properties.length > 1 ? 1 : properties.length;
                    properties.splice(index, 0,
                        { object: "property", id: "descriptionId", key: "description", name: Localize("Description", state.language), format: "text" }
                    );
                }
                else {
                    const index = properties.indexOf(description);
                    if (index !== -1 && index !== 1) {
                        properties.splice(index, 1);
                        properties.splice(1, 0, description);
                    }
                }

                selectedSpaceId = form.spaceId;

                const name = (form.formName) || ((form.type.icon.format === "emoji" ? (form.type.icon.emoji + " ") : "") + form.type.name);
                elements.objectNameToSave.innerText = name;

                let propertiesForPrintWithoutDefaultValue = [];
                let propertiesForPrintWithDefaultValue = [];

                for (const property of properties) {

                    let needToCreateChoices = false;

                    const savedProperty = form.properties.find(p => p.AnytypeProperty.id === property.id);
                    const savedPropertyValueExist = savedProperty !== null && savedProperty !== undefined
                        && savedProperty.SelectedValueByUser !== null && savedProperty.SelectedValueByUser !== "null"
                        && savedProperty.SelectedValueByUser !== undefined && savedProperty.SelectedValueByUser.length > 0;

                    consoleLog('Found saved property: ', savedProperty);

                    if (property.format === "files") continue; // images will be added later
                    if (property.name === "Created by") continue; // we don't need this
                    if (property.name === "Creation date") continue; // we don't need this

                    let propertyHTML = document.createElement(`div`);

                    if (property.format === "text" || property.format === "email"
                        || property.format === "number" || property.format === "url"
                        || property.format === "date" || property.format === "checkbox"
                        || property.key === "description" || property.format === "phone") {

                        needToCreateChoices = false;

                        let value = null;
                        const printTextarea = property.key === "description" || property.key === "objectBodyKeySaveToAnytype";

                        if (savedPropertyValueExist) {
                            value = GetPagePropiertie(savedProperty.SelectedValueByUser);
                        }

                        propertyHTML.innerHTML = `
                                    ` + (property.format != "checkbox" ? '<div class="poperty-head">' : "") + `
                                        ` + GetPropertyIconSVG(property.format) + `
                                        <div class="section-title">` + property.name + `</div>
                                    ` + (property.format != "checkbox" ? '</div>' : "") + `
                                    <div class="form-group ` + (property.format === "checkbox" ? "checkbox-rect" : "") + `">
                                        <` + (printTextarea ? "textarea " : "input") + ` 
                                            id="` + property.id + `_SO" 
                                            type="` + (property.format !== "phone" ? property.format : "tel") + `" 
                                            placeholder="` + property.name + `" `
                            + (savedPropertyValueExist && !printTextarea ? (`value="` + value + `" `) : (` `)) + `
                                        >` + (printTextarea ? (savedPropertyValueExist ? (value + "</textarea>") : "</textarea>") : "") + `
                                    ` + (property.format === "checkbox" ? '<label for="' + property.id + '_SO"></label>' : "") + `    
                                    </div>
                                `;
                    }
                    else if (property.format === "objects") {
                        needToCreateChoices = true;

                        await loadAllObjects();

                        propertyHTML.innerHTML = `
                                    <div class="poperty-head">
                                        ` + GetPropertyIconSVG(property.format) + `
                                        <div class="section-title">` + property.name + `</div>
                                    </div>
                                    <div class="form-group">
                                        <select id="` + property.id + `_SO">
                                            ${allObjects.map(o => `
                                                <option 
                                                    value="${o.id}" 
                                                    ` + ((savedPropertyValueExist && savedProperty.SelectedValueByUser == o.id) ? "selected" : "") + `
                                                >
                                                    ${o.name || o.id}
                                                </option>
                                                `).join("")}
                                        </select>
                                    </div>
                                `;
                    }
                    else if (property.format === "select" || property.format === "multi_select") {
                        needToCreateChoices = true;
                        const tags = await loadPropertieTags(property.id);

                        propertyHTML.innerHTML = `
                                    <div class="poperty-head">
                                        ` + GetPropertyIconSVG(property.format) + `
                                        <div class="section-title">` + property.name + `</div>
                                    </div>
                                    <div class="form-group">
                                        <select id="` + property.id + `_SO" ` + (property.format === "multi_select" ? `multiple` : ``) + `>
                                            ${tags.map(o => `
                                                <option 
                                                    value="${o.id}" 
                                                    ` + ((savedPropertyValueExist && savedProperty.SelectedValueByUser.includes(o.id)) ? "selected" : "") + `
                                                >
                                                    ${o.name || o.id}
                                                </option>
                                                `).join("")}
                                        </select>
                                    </div>
                                `;
                    }

                    if (property.format === "checkbox") {
                        propertyHTML.classList.add("poperty-head");
                    }

                    if (savedPropertyValueExist && property.id !== "nameId")
                        propertiesForPrintWithDefaultValue.push({ needToCreateChoices: needToCreateChoices, needToDisableChoice: !savedPropertyValueExist, propertyHTML: propertyHTML, propertyId: property.id, propertyKey: property.key, value_type: property.format });
                    else
                        propertiesForPrintWithoutDefaultValue.push({ needToCreateChoices: needToCreateChoices, needToDisableChoice: !savedPropertyValueExist, propertyHTML: propertyHTML, propertyId: property.id, propertyKey: property.key, value_type: property.format });
                }

                await loadCollections();

                if (allCollections != null && allCollections != undefined && allCollections.length > 0) {
                    let propertyHTML = document.createElement(`div`);

                    const savedCollectionExist = form.collectionId !== null && form.collectionId !== undefined;

                    propertyHTML.innerHTML = `
                                <div class="poperty-head">
                                    ` + GetPropertyIconSVG("collection") + `
                                    <div class="section-title">` + Localize("SelectCollection", state.language) + `</div>
                                </div>
                                <div class="form-group">
                                    <select id="CollectionPrintedSaveToAnytype_SO" >
                                        ${allCollections.map(o => `
                                            <option 
                                                value="${o.id}" 
                                                ` + ((savedCollectionExist && form.collectionId === o.id) ? "selected" : "") + `
                                            >
                                                ${o.name || o.id}
                                            </option>
                                            `).join("")}
                                    </select>
                                </div>
                            `;

                    propertiesForPrintWithDefaultValue.push({ needToCreateChoices: true, needToDisableChoice: !savedCollectionExist, propertyHTML: propertyHTML, propertyId: "CollectionPrintedSaveToAnytype", propertyKey: "CollectionPrintedSaveToAnytype" });
                }

                await loadObjectTemplates(form.type.id);

                if (allTemplatesForObject != null && allTemplatesForObject != undefined && allTemplatesForObject.length > 0) {
                    let propertyHTML = document.createElement(`div`);

                    const savedTemplateExist = form.templateId !== null && form.templateId !== undefined;

                    propertyHTML.innerHTML = `
                                <div class="poperty-head">
                                    ` + GetPropertyIconSVG("template") + `
                                    <div class="section-title">` + Localize("SelectObjectTemplate", state.language) + `</div>
                                </div>
                                <div class="form-group">
                                    <select id="TemplatePrintedSaveToAnytype_SO" >
                                        ${allTemplatesForObject.map(o => `
                                            <option 
                                                value="${o.id}" 
                                                ` + ((savedTemplateExist && form.templateId === o.id) ? "selected" : "") + `
                                            >
                                                ${o.name || o.id}
                                            </option>
                                            `).join("")}
                                    </select>
                                </div>
                            `;

                    propertiesForPrintWithDefaultValue.push({ needToCreateChoices: true, needToDisableChoice: !savedTemplateExist, propertyHTML: propertyHTML, propertyId: "TemplatePrintedSaveToAnytype", propertyKey: "TemplatePrintedSaveToAnytype" });
                }

                if (propertiesForPrintWithoutDefaultValue.length > 0) {
                    elements.propertiesSaveObjectListWithoutDefaultValueHandler.classList.remove('hidden');
                }
                else {
                    elements.propertiesSaveObjectListWithoutDefaultValueHandler.classList.add('hidden');
                }

                if (propertiesForPrintWithDefaultValue.length > 0) {
                    elements.propertiesSaveObjectListWithDefaultValueHandler.classList.remove('hidden');
                }
                else {
                    elements.propertiesSaveObjectListWithDefaultValueHandler.classList.add('hidden');
                }

                for (let index = 0; index < propertiesForPrintWithoutDefaultValue.length; index++) {
                    const propertieForPrint = propertiesForPrintWithoutDefaultValue[index];

                    elements.propertiesSaveObjectListWithoutDefaultValueHandler.appendChild(propertieForPrint.propertyHTML);

                    propertiesListForSaving.push({ KeyForAnytypeAPI: propertieForPrint.propertyKey, IdInHTML: propertieForPrint.propertyId + "_SO", value_type: propertieForPrint.value_type });

                    if (propertieForPrint.needToCreateChoices) {
                        const choice = new Choices(document.getElementById(propertieForPrint.propertyId + "_SO"), {
                            removeItemButton: true,
                            searchEnabled: true,
                            shouldSort: false,
                        });

                        if (propertieForPrint.needToDisableChoice)
                            choice.removeActiveItems();
                    }
                }

                for (let index = 0; index < propertiesForPrintWithDefaultValue.length; index++) {
                    const propertieForPrint = propertiesForPrintWithDefaultValue[index];

                    elements.propertiesSaveObjectListWithDefaultValueHandlerContent.appendChild(propertieForPrint.propertyHTML);

                    propertiesListForSaving.push({ KeyForAnytypeAPI: propertieForPrint.propertyKey, IdInHTML: propertieForPrint.propertyId + "_SO", value_type: propertieForPrint.value_type });

                    if (propertieForPrint.needToCreateChoices) {
                        const choice = new Choices(document.getElementById(propertieForPrint.propertyId + "_SO"), {
                            removeItemButton: true,
                            searchEnabled: true,
                            shouldSort: false,
                        });

                        if (propertieForPrint.needToDisableChoice)
                            choice.removeActiveItems();
                    }
                }

                elements.propertiesSaveObjectListWithDefaultValueHandlerToggleText.textContent = Localize("FilledProperties", state.language);

                if (state.collapseOnOpenForm == "true") {
                    if (!elements.propertiesSaveObjectListWithDefaultValueHandler.classList.contains('collapsed'))
                        elements.propertiesSaveObjectListWithDefaultValueHandler.classList.add('collapsed');

                    elements.propertiesSaveObjectListWithDefaultValueHandlerToggleSign.textContent = "";
                }
                else {
                    if (elements.propertiesSaveObjectListWithDefaultValueHandler.classList.contains('collapsed'))
                        elements.propertiesSaveObjectListWithDefaultValueHandler.classList.remove('collapsed');

                    elements.propertiesSaveObjectListWithDefaultValueHandlerToggleSign.textContent = "";
                }

                if (!WasSubscribeToggleCollapsedButton) {
                    WasSubscribeToggleCollapsedButton = true;
                    elements.propertiesSaveObjectListWithDefaultValueHandlerToggle.addEventListener('click', () => {
                        elements.propertiesSaveObjectListWithDefaultValueHandler.classList.toggle('collapsed');

                        if (elements.propertiesSaveObjectListWithDefaultValueHandler.classList.contains('collapsed')) {
                            elements.propertiesSaveObjectListWithDefaultValueHandlerToggleSign.textContent = "";
                        } else {
                            elements.propertiesSaveObjectListWithDefaultValueHandlerToggleSign.textContent = "";
                        }
                    });
                }


            } else {
                console.error('Type object for save could not be loaded: ', typesResponse.status);
                consoleError('Type object for save could not be loaded: ', typesResponse.status);
                showStatus(Localize("FailedToLoadObject", state.language) + typesResponse.status, "error")
            }
        } catch (error) {
            console.error(error);
            consoleError('Type object for save could not be loaded: ', error);
            showStatus(Localize("FailedToLoadObject", state.language) + error.messsage, "error")
        }
    }

    elements.saveObjectBtn.addEventListener('click', async () => {
        consoleLog("Start saving object");
        consoleLog("properties List For Saving: " + propertiesListForSaving);

        elements.saveObjectBtnText.innerHTML = '<span class="loading"></span> ' + Localize("Saving", state.language);
        elements.saveObjectBtn.disabled = true;

        try {
            let properties_final_list = [];
            let objectName = null;
            let objectBody = null;
            let ObjectCollectionId = null;
            let ObjectTemplateId = null;

            for (let index = 0; index < propertiesListForSaving.length; index++) {
                const propiertyPrinted = propertiesListForSaving[index];

                if (propiertyPrinted.KeyForAnytypeAPI !== "nameKeySaveToAnytype"
                    && propiertyPrinted.KeyForAnytypeAPI !== "CollectionPrintedSaveToAnytype"
                    && propiertyPrinted.KeyForAnytypeAPI !== "TemplatePrintedSaveToAnytype"
                    && propiertyPrinted.KeyForAnytypeAPI !== "objectBodyKeySaveToAnytype"
                ) {
                    let value = null;

                    if (propiertyPrinted.value_type === "checkbox")
                        value = document.getElementById(propiertyPrinted.IdInHTML).checked;
                    else if (propiertyPrinted.value_type === "multi_select" || propiertyPrinted.value_type === "objects")
                        value = Array.from(document.getElementById(propiertyPrinted.IdInHTML).options).filter(opt => opt.selected).map(opt => opt.value);
                    else
                        value = document.getElementById(propiertyPrinted.IdInHTML).value;

                    if (value !== null && value !== undefined && value !== "")
                        properties_final_list.push({ key: propiertyPrinted.KeyForAnytypeAPI, [propiertyPrinted.value_type]: value });
                }
                else if (propiertyPrinted.KeyForAnytypeAPI === "nameKeySaveToAnytype") {
                    objectName = document.getElementById(propiertyPrinted.IdInHTML).value;
                }
                else if (propiertyPrinted.KeyForAnytypeAPI === "CollectionPrintedSaveToAnytype") {
                    ObjectCollectionId = document.getElementById(propiertyPrinted.IdInHTML).value;
                }
                else if (propiertyPrinted.KeyForAnytypeAPI === "TemplatePrintedSaveToAnytype") {
                    ObjectTemplateId = document.getElementById(propiertyPrinted.IdInHTML).value;
                }
                else if (propiertyPrinted.KeyForAnytypeAPI === "objectBodyKeySaveToAnytype") {
                    objectBody = document.getElementById(propiertyPrinted.IdInHTML).value;
                }
            }

            consoleLog("properties_final_list: " + properties_final_list);
            consoleLog("objectName: " + objectName);
            consoleLog("objectBody: " + objectBody);
            consoleLog("ObjectCollectionId: " + ObjectCollectionId);
            consoleLog("ObjectTemplateId: " + ObjectTemplateId);

            // Create object in Anytype
            let objectData = {
                name: objectName,
                body: objectBody,
                type_key: currentForm.type.key || 'page',
                properties: properties_final_list
            };

            if (ObjectTemplateId !== null && ObjectTemplateId !== undefined && ObjectTemplateId !== '')
                objectData["template_id"] = ObjectTemplateId;

            consoleLog('Sending object data:', objectData);
            consoleLog('Using type_key:', currentForm.type.key || 'page');

            const response = await fetch(`${API_BASE_URL}/spaces/${selectedSpaceId}/objects`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json',
                    'Anytype-Version': API_VERSION
                },
                body: JSON.stringify(objectData)
            });

            const responseText = await response.text();
            consoleLog('Create object response:', response.status, responseText);

            if (response.ok) {
                let createdObjectId = null;
                try {
                    const data = JSON.parse(responseText);
                    createdObjectId = data?.object?.id || null;
                } catch (e) {
                    consoleLog('Response is not JSON:', responseText);
                }

                consoleLog('Object created:', createdObjectId);

                state.LastUsedForm = currentForm;
                saveState();

                // If a collection is selected, try to add the object to it
                if (ObjectCollectionId !== null && ObjectCollectionId !== undefined && ObjectCollectionId !== '' && createdObjectId) {
                    try {
                        consoleLog('Adding to collection:', ObjectCollectionId, 'Object ID:', createdObjectId);

                        const collectionResponse = await fetch(
                            `${API_BASE_URL}/spaces/${selectedSpaceId}/lists/${ObjectCollectionId}/objects`,
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${state.apiKey}`,
                                    'Content-Type': 'application/json',
                                    'Anytype-Version': API_VERSION
                                },
                                body: JSON.stringify({ objects: [createdObjectId] })
                            }
                        );

                        const collectionResponseText = await collectionResponse.text();
                        consoleLog('Add to collection response:', collectionResponse.status, collectionResponseText);

                        if (!collectionResponse.ok) {
                            consoleLog('Could not add to collection. Status:', collectionResponse.status, 'Response:', collectionResponseText);
                        } else {
                            consoleLog('Successfully added to collection');
                        }
                    } catch (error) {
                        consoleLog('Could not add to collection:', error);
                    }
                }

                elements.OpenInAnytypeBtn.addEventListener('click', async () => {
                    open("Anytype://object?objectId=" + createdObjectId + "&spaceId=" + selectedSpaceId, "_blank");
                });

                showobjectSavedSection();

            } else {
                let erroressage = 'Save error';
                try {
                    const errorData = JSON.parse(responseText);
                    erroressage = errorData.message || errorData.error || responseText;
                } catch (e) {
                    erroressage = responseText;
                }

                showStatus(`Save error: ${erroressage}`, 'error');
            }
        } catch (error) {
            console.error(error);
            consoleError('Save error:', error.messsage);
            showStatus('Connection error: ' + error.message, 'error');
        } finally {
            elements.saveObjectBtnText.innerHTML = 'Save';
            elements.saveObjectBtn.disabled = false;
        }
    });

    //#endregion

    //#region Tips

    function attachTooltip(element, textKey) {
        let tooltip = null;

        element.addEventListener("mouseenter", () => {
            tooltip = document.createElement("div");
            tooltip.className = "custom-tooltip";
            tooltip.innerText = Localize(textKey, state.language);
            document.body.appendChild(tooltip);

            const updatePosition = (e) => {
                tooltip.style.left = (e.clientX - 10) + "px";
                tooltip.style.top = (e.clientY + 30) + "px";
            };

            element._tooltipMoveHandler = updatePosition;

            element.addEventListener("mousemove", updatePosition);
            setTimeout(() => tooltip.style.opacity = "1", 10);
        });

        element.addEventListener("mouseleave", () => {
            if (tooltip) {
                tooltip.remove();
                tooltip = null;
            }
            element.removeEventListener("mousemove", element._tooltipMoveHandler);
        });
    }

    attachTooltip(elements.createFormTipButton, "CreateFormTip");

    //#endregion

};